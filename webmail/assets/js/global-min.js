var GLOBALS={cron_save_draft:null,cron_keep_alive:null,lock_keep_alive:false,last_request:null};(function(e){function t(){window.location="?box=Inbox&boxfull=INBOX"}function n(t){e("#modal-content,#modal-background").addClass("active");e("#modal-content").addClass("active").html(t);e("#modal-background").on("click",function(){e("#modal-content,#modal-background").removeClass("active")})}function r(){if(e("body img.loading").length){e("body img.loading").remove()}else{e("body").prepend('<img class="loading" src="assets/img/ajax-loader.gif" style="left: 60%; top: 37%; position: absolute; z-index: 100;" />')}}function i(t,n,s,o){sessionStorage.removeItem("title");sessionStorage.removeItem("sender");sessionStorage.removeItem("body");sessionStorage.removeItem("cc");e("div.container ul.top-menu.active").removeClass("active").css("display","none");e("div.container ul.top-menu.email").addClass("active").css("display","");GLOBALS.last_request=e.ajax({url:"inc/dump_body.php",type:"POST",data:{mailbox:n,email_uid:t},dataType:"html",beforeSend:function(){r()}}).done(function(t){r();var n=a("box","Inbox");if(n.match(/^drafts$/i)){e("body").append('<div id="draft_content" style="display: hidden;" />');var f=e("div#draft_content");f.html(t);var l=e("#uid").val();var c=f.find("div.email_header h1:first").text();var h=[];var p=[];var d=f.find("div.email-body").html();var v=[];f.find("div.attachments ul li a").each(function(){var t=e(this);v.push(t.attr("title").replace(/\s+\([^\)]*\)$/i,""))});v.join("|");f.find("div.email_header a.mail-to, div.email_header a.mail-from").each(function(t,n){var r=e(this);var i=r.prev("span.name").text().replace(/['"]/g,"");var s=r.text().replace(/['"]/g,"");var o=e("#self_mail").val();i=i?i:s;if(s!=o){if(i&&s){h.push({label:i,value:s})}}});h=JSON.stringify(h);f.find("div.email_header a.mail-cc").each(function(t,n){var r=e(this);var i=r.prev("span.name").text().replace(/['"]/g,"");var s=r.text().replace(/['"]/g,"");i=i?i:s;if(i&&s){p.push({label:i,value:s})}});p=JSON.stringify(p);sessionStorage.setItem("uid",l);sessionStorage.setItem("type","draft");sessionStorage.setItem("title",c);sessionStorage.setItem("sender",h);sessionStorage.setItem("cc",p);sessionStorage.setItem("body",d);sessionStorage.setItem("attachments",v);f.remove();e("a.opt-new").trigger("click");return}if(typeof s==="undefined"){s="div.stage"}e(s).html(['<div class="printable" style="padding-left: 5px;">',t,"</div>"].join("\n"));if(typeof o==="function")o();e("div.email_header img.email_up").on("click",function(){var t=e("div.email_header input#uid").val();GLOBALS.last_request=e.ajax({url:"inc/get_next_uid.php",type:"POST",data:{uid:t},dataType:"json",beforeSend:function(){r()}}).done(function(e){r();if(e.error){alert("Não existe próximo email.")}else{if(e.new_uid){var t=e.new_uid;var n=a("boxfull",a("box","Inbox"));i(t,n)}}})});e("div.email_header img.email_down").on("click",function(){var t=e("div.email_header input#uid").val();GLOBALS.last_request=e.ajax({url:"inc/get_prev_uid.php",type:"POST",data:{uid:t},dataType:"json",beforeSend:function(){r()}}).done(function(e){r();if(e.error){alert("Não existe email anterior.")}else{if(e.new_uid){var t=e.new_uid;var n=a("boxfull",a("box","Inbox"));i(t,n)}}})});e("div.email_header span.email a").on("click",function(){var t=e(this);var n=t.text();var r=t.prev("span.name").text()||n;var i=confirm("Adicionar "+r+" aos contatos?");if(i){GLOBALS.last_request=e.ajax({url:"inc/contact_add.php",type:"POST",data:{name:r,email:n,address:""}}).done(function(e){if(e&&e.match(/^Error/i)){alert(e)}u("%")})}return false})});return false}function s(){GLOBALS.last_request=e.ajax({url:"inc/request_to_buffer.php",type:"POST",dataType:"json",data:{where:"list_mailboxes"}}).done(function(t){var n=t.mailboxes_tree;var r=t.mailboxes;var i=a("box","Inbox");e("div.container nav.sidebar .sidebar-pastas").html(traverse(n,"lista_pastas"));e("#lista_pastas").treeview({collapsed:true})})}function o(n,s,u,f){var l=a("boxfull","INBOX");if(l.match(/^INBOX.Inbox$/gi)){t()}n=n?n:a("box","Inbox");s=s?s:a("query","ALL");u=u?u:a("page","1");if(n.match(/^drafts$/i)){e("div.container ul.top-menu.active").removeClass("active").css("display","none");e("div.container ul.top-menu.drafts").addClass("active").css("display","")}if(n.match(/^trash$/i)){e("div.container ul.top-menu.active").removeClass("active").css("display","none");e("div.container ul.top-menu.trash").addClass("active").css("display","")}if(n.match(/^junk$/i)){e("div.container ul.top-menu.active").removeClass("active").css("display","none");e("div.container ul.top-menu.spam").addClass("active").css("display","")}var c="";var h="";if(f&&f.query&&f.order){c=f.query;h=f.order}GLOBALS.last_request=e.ajax({url:"inc/request_to_buffer.php",data:{where:"list_emails",search_query:s,box:n,boxfull:l,page:u,sort_query:c,sort_order:h},type:"POST",dataType:"json",beforeSend:function(){r()},error:function(e,t,n){console.error("Error Status: "+t);console.error(e.statusText);console.error(e.responseText);console.error(e.status)}}).done(function(t){var n=a("box","Inbox");var s=t.emails;var u=t.pagination;r();if(!s.length){e("div.stage").html('<span class="no-result">Nada encontrado.</span>');return false}if(n.match(/^drafts$/i)||n.match(/^sent$/i)){e("div.stage").html(['<table class="mail_list sent_list" cellspacing="0">',"   <thead>","       <tr>",'           <td><input type="checkbox" class="select_all" /></td>','           <td data-column="subject" class="subject">Assunto</td>','           <td data-column="recipient" class="recipient">Destinatário</td>',"           <td></td>",'           <td data-column="date" class="date">Data</td>',"       </tr>","   </thead>","   <tbody>","   </tbody>","</table>",'<div style="clear: both;"></div>','<div class="usage"><b>'+t.percent_usage+"% de espaço em uso</b> ("+t.quota_info+")</div>",'<div class="pagination"></div>'].join("\n"))}else{e("div.stage").html(['<table class="mail_list main_list" cellspacing="0">',"   <thead>","       <tr>",'           <td><input type="checkbox" class="select_all" /></td>','           <td data-column="sender" class="sender">Remetente</td>',"           <td></td>",'           <td data-column="subject" class="subject">Assunto</td>',"           <td></td>",'           <td data-column="date" class="date">Data</td>',"       </tr>","   </thead>","   <tbody>","   </tbody>","</table>",'<div style="clear: both;"></div>','<div class="usage"><b>'+t.percent_usage+"% de espaço em uso</b> ("+t.quota_info+")</div>",'<div class="pagination"></div>'].join("\n"))}var f="";if(t.order_by&&t.order){var l=e("table.mail_list");if(t.order_by=="SORTFROM"){t.order_by="sender"}else if(t.order_by=="SORTTO"){t.order_by="recipient"}else if(t.order_by=="SORTSUBJECT"){t.order_by="subject"}else if(t.order_by=="SORTDATE"){t.order_by="date"}l.attr("data-orderby",t.order_by);l.attr("data-order",t.order);var c=t.order=="desc"?"column-order-down":"column-order-up";e("table.mail_list thead tr td").removeClass("column-order-up column-order-down");e("table.mail_list thead tr td."+t.order_by).append("<div />").addClass(c)}e("div.stage div.pagination").html("").append(u);for(var h=0,p=0;h<s.length;++h,p=p?0:1){var d=s[h];var v=[];var m=d.from;var g="";if(d.from!=null)d.from=d.from.replace(/\s+&lt;.*$/i,"").replace(/('|"|&quot;)/g,"");if(d.from!=null&&d.from.length>30){d.from=d.from.substr(0,27);if(d.from.match(/\.$/i))d.from+="..";else d.from+="..."}if(n.match(/^drafts$/i)||n.match(/^sent$/i)){v=['<tr class="'+d.li_class+'" '+(p?'style="background: #f3f3f3;"':"")+" >",'    <td class="mail_selector" style="padding: 1px; width: 25px;"><input type="checkbox" value="'+d.uid+'"></td>','    <td class="mail_subject"><a href="#" uid="'+d.uid+'" number="'+d.number+'">'+d.subject+"</a></td>",'    <td class="mail_to">'+(d.to?d.to:"(Sem destinatário)")+"</td>",'    <td class="mail_has_att">'+(d.has_reply?'<img src="assets/img/reply.gif" style="margin-bottom: -4px" title="Respondido" width="16" />':"")+" "+(d.has_rw?'<img src="assets/img/rw.png" style="margin-bottom: -4px" title="E-mail já foi encaminhado" width="16" />':"")+""+(d.has_att?'<img src="assets/img/attachment.png" title="E-mail com anexo" width="20" style="margin-bottom: -4px; margin-right:5px"/>':"")+"</td>",'    <td class="mail_date">'+d.date+"</td>","</tr>"].join("\n")}else{v=['<tr class="'+d.li_class+'" '+(p?'style="background: #f3f3f3;"':"")+" >",'    <td class="mail_selector" style="padding: 1px; width: 25px;"><input type="checkbox" value="'+d.uid+'"></td>','    <td class="mail_from" title="'+m+'">'+d.from+"</td>","    <td>"+(d.has_reply?'<img src="assets/img/reply.gif" style="margin-bottom: -4px" title="Respondido" width="16" />':"")+" "+(d.has_rw?'<img src="assets/img/rw.png" style="margin-bottom: -4px" title="E-mail já foi encaminhado" width="16" />':"")+"</td>",'    <td class="mail_subject" title="'+g+'"><a href="#" uid="'+d.uid+'" number="'+d.number+'">'+d.subject+"</a></td>",'    <td class="mail_has_att">'+(d.has_att?'<img src="assets/img/attachment.png"  title="E-mail com anexo" width="20" style="margin-bottom: -4px; margin-right:5px" />':"")+"</td>",'    <td class="mail_date">'+d.date+"</td>","</tr>"].join("\n")}e("div.stage table.mail_list tbody").append(e(v))}e("div.stage table.mail_list thead :checkbox").on("change",function(){var t=e(this).is(":checked");e("div.stage table.mail_list tbody :checkbox").each(function(e,n){n.checked=t})});e("div.stage table.mail_list thead tr td").on("click",function(){var t=e(this);var n=e("table.mail_list");var r=t.data("column");var i=e("#email_search").val();var s={query:"",order:""};if(typeof r==="undefined")return;if(n.data("orderby")==r){s.order=n.data("order")=="desc"?"asc":"desc"}else{s.order="asc"}switch(r){case"sender":s.query="SORTFROM";break;case"recipient":s.query="SORTTO";break;case"subject":s.query="SORTSUBJECT";break;case"date":s.query="SORTDATE";break}if(i){i="SUBJECT "+i}else{i="ALL"}o(false,i,false,s)});(function(){var t=700;var n=0;var s=null;e("div.stage table.mail_list tr td.mail_subject a").on("click",function(){var o=e(this);n++;if(n===1){s=setTimeout(function(){var t=o.attr("uid");var s=a("boxfull",a("box","Inbox"));e('<div class="email_preview"></div>').insertAfter("div.stage");r();i(t,s,"div.email_preview",function(){e("div.email_preview").find("img.email_up").remove();e("div.email_preview").find("img.email_down").remove();e("div.email_preview").find("div.email_link_back").remove();e("div.email_preview").prepend('<img class="preview_close" src="assets/img/delete.png" style="width: 15px; height: 15px; margin: 3px; cursor: pointer;">');e("div.email_preview img.preview_close").on("click",function(){e("div.email_preview").remove();e("div.container ul.top-menu.active").removeClass("active").css("display","none");e("div.container ul.top-menu.principal").addClass("active").css("display","")});r()});n=0},t)}else{clearTimeout(s);var u=o.attr("uid");var f=a("boxfull",a("box","Inbox"));e("div.email_preview").remove();i(u,f);n=0}}).on("dblclick",function(e){e.preventDefault()})})()})}function u(t){GLOBALS.last_request=e.ajax({url:"inc/list_contacts.php",data:{pattern:t},type:"POST",dataType:"json"}).done(function(t){var n=[];if(t.results.length){n.push('<ul id="lista_contatos">');for(var i=0;i<t.results.length;++i){n.push('<li><a href="#" class="contact" title="'+t.results[i].name+'" data-email="'+t.results[i].email+'">'+t.results[i].name+"</a></li>")}n.push("</ul>")}else{n.push("<span>Nenhum contato</span>")}e("nav.sub-sidebar.sidebar-contatos").html(n.join("\n"));e("nav.sub-sidebar.sidebar-contatos ul a.contact").on("click",function(){var t=e(this);var n=t.data("email");GLOBALS.last_request=e.ajax({url:"inc/contact_info.php",data:{email:n},dataType:"json",type:"POST",beforeSend:function(){r()}}).done(function(t){r();if(t){e("div.stage").html(['<div class="contact_info">','   <input type="hidden" name="original_mail" value="'+t.email+'" />','   <label for="contact_name">Nome</label><br /><input type="text" name="contact_name" id="contact_name" size="60" value="'+t.name+'" /><br />','   <label for="contact_email">Email</label><br /><input type="text" name="contact_email" id="contact_email" size="60" value="'+t.email+'" /><br />','   <label for="contact_addr">Endereço</label><br /><input type="text" name="contact_addr" id="contact_addr" size="100" value="'+t.address+'" /><br />','   <input type="button" name="save" value="Salvar" />','   <input type="button" name="delete" value="Deletar" />',"</div>"].join("\n"));e("div.contact_info input[name=delete]").on("click",function(){var t=e("input#contact_email").val();GLOBALS.last_request=e.ajax({url:"inc/delete_contact.php",type:"POST",data:{contact_email:t},beforeSend:function(){r()}}).done(function(){r();u()})});e("div.contact_info input[name=save]").on("click",function(){var t=e("input[name=original_mail]").val();var n=e("input#contact_name").val();var i=e("input#contact_email").val();var s=e("input#contact_addr").val();GLOBALS.last_request=e.ajax({url:"inc/save_contact_info.php",type:"POST",data:{original_mail:t,name:n,email:i,addr:s},beforeSend:function(){r()}}).done(function(t){r();if(t){alert(t);e("input#contact_email").focus()}u()})})}});return false})})}function a(e,t){t=t!=="undefined"?t:null;var n=decodeURI((RegExp(e+"="+"(.+?)(&|$)").exec(location.search)||[,t])[1]);return n==="null"?null:n}function f(){try{var t=[];var n=[];var r=[];var i=e("div.stage div#email-editor input#subject").val();var s=e("div.cke_inner iframe").contents().find("body").html();var o=[];e("div#attachments_list span").each(function(){o.push("uploads/"+e(this).text().replace(/^\s+|\s+$/g,""))});o=o.join("|");e("#to li").each(function(n,r){t.push(e(r).attr("tagvalue"))});t=t.join(",");e("#cc li").each(function(t,r){n.push(e(r).attr("tagvalue"))});n=n.join(",");e("#cco li").each(function(t,n){r.push(e(n).attr("tagvalue"))});r=r.join(",");GLOBALS.last_request=e.ajax({url:"inc/save_draft.php",type:"POST",dataType:"json",data:{recipients:t,recipients_cc:n,recipients_cco:r,subject:i,email_body:s,attachments:o}}).done(function(t){if(t.draft_uid){var n=t.draft_uid;if(sessionStorage.last_draft_uid){GLOBALS.last_request=e.ajax({url:"inc/mail_delete.php",type:"POST",data:{permanent:true,maillist:sessionStorage.last_draft_uid,boxfull:"INBOX.Drafts"},dataType:"json"}).done(function(e){sessionStorage.setItem("last_draft_uid",n)})}else{sessionStorage.setItem("last_draft_uid",n)}}})}catch(u){console.log(u)}}window.load_emails=o;e(document).ready(function(){e.ajax({url:"inc/request_to_buffer.php",type:"POST ",dataType:"JSON",data:{where:"list_mailboxes"}}).done(function(e){console.log(e)});GLOBALS.cron_keep_alive=setInterval(function(){GLOBALS.last_request=e.ajax({url:"inc/imap_connection.php",type:"GET"});if(!GLOBALS.lock_keep_alive){o(false,false,false)}},1e3*60*5);e("nav.sidebar").resizable({ghost:true,minWidth:197});(function(){u("%");s();o(false,false,false)})();(function(){jQuery.support.placeholder=function(){var e=document.createElement("input");return"placeholder"in e}();if(!e.support.placeholder){e("[placeholder]").focus(function(){var t=e(this);if(t.val()===t.attr("placeholder")){t.val("");t.removeClass("placeholder")}}).blur(function(){var t=e(this);if(t.val()===""||t.val()===t.attr("placeholder")){t.addClass("placeholder");t.val(t.attr("placeholder"))}}).blur()}})();e("ul.top-menu a.opt-print").on("click",function(){var t=window.open("","p_window");var n=!confirm("Incluir anexos na impressão?")?"div.attachments{display: none !important;}":"";var r=e(".email_header > h1:nth-child(2)","div.stage").text();var i=["<!doctype htmfl>","<html>","   <head>","       <title>"+r+"</title>",'       <style type="text/css">@media print{body{width:800px;height:100%;margin:0;padding:0;font-size:13px;font-family:Tahoma,Geneva,sans-serif}div.email_header{width:90%;color:#2b2b2b;margin-bottom:30px}div.email_header h1{font-size:16px}div.email_header span{margin-right:20px}div.email_header span.date{float:right;text-align:right;font-weight:700}div.email_header span.time{float:right;text-align:right;font-weight:700}div.email_header div.header-separator{width:100%;padding:5px 0;margin-bottom:20px;border-bottom:2px solid #595959}div.email_header span.email span{margin:0}div.pagination{padding:10px;position:fixed;bottom:38px}div.pagination a{padding:2px 5px;margin:2px;text-decoration:none;color:#2f75fa}div.pagination a:hover,div.pagination a:active{border-bottom:1px solid #2f75fa;color:#000}div.pagination span.current{padding:2px 5px;margin:2px;border:1px solid #2f75fa;font-weight:700;background-color:#2f75fa;color:#fff}div.pagination span.disabled{padding:2px 5px;margin:2px;color:#000}div.email_header div.attachments{margin:10px 0 -16px}div.email_header div.attachments ul{margin:0;padding:0;width:800px}div.email_header div.attachments ul li{list-style:none;margin-left:auto;margin-right:auto;display:inline-block}div.email_header div.attachments ul li a{display:inline-block;text-decoration:none;color:#000;text-align:center}div.email_header div.attachments ul li a img{float:left;width:100px;width:100px}div.email_header div.attachments ul li a p{clear:both;font-size:12px;font-family:Tahoma,Geneva,sans-serif}'+n+"}</style>","   </head>","   <body>",e("div.stage").html(),"   </body>","</html>"].join("\n");t.document.write(i);t.print();t.close()});e("ul.top-menu a.opt-delete").on("click",function(){var n=e("input[type=hidden]#uid").val();var r=[];if(n){r.push(n)}else{e("td.mail_selector input[type=checkbox]:checked").each(function(t,n){var i=e(n);r.push(i.val())})}var i=a("box","INBOX");var s=a("boxfull","INBOX");var o=a("query","ALL");var u=a("page","1");var f=i.match(/^(trash|junk)$/i)?"1":"0";GLOBALS.last_request=e.ajax({url:"inc/mail_delete.php",type:"POST",data:{permanent:f,maillist:r.join(","),box:i,boxfull:s},dataType:"json"}).done(function(e){if(e.errors){console.log(e.errors+" emails não foram excluidos.");alert(e.errors+" emails não foram excluidos.")}else{t()}});return false});e("ul.top-menu a.opt-move").on("click",function(){GLOBALS.last_request=e.ajax({url:"inc/request_to_buffer.php",type:"POST",dataType:"json",data:{where:"list_mailboxes"}}).done(function(r){var i=r.mailboxes;var s="<h4>Mover para:</h4><ul>";for(var o=0,u=0;o<i.length;++o,++u){var f=u%2?" odd":" even";var l=i[o].mailbox;i[o]=i[o].mailbox.replace(/inbox/i,"Inbox").replace(/inbox\./i,"").replace(/\./i,"/");if(i[o].match(/^drafts$/i)||i[o].match(/^sent$/i)){++u;continue}var c=i[o].replace(/^inbox$/i,"Entrada").replace(/^trash$/i,"Lixeira").replace(/^sent$/i,"Enviados").replace(/^junk$/i,"Spam");s+='<li class="target-mailbox'+f+'" data-boxfull="'+l+'">'+c+"</li>"}s+="</ul>";n(s);e("li.target-mailbox").on("click",function(){var n=e(this);var r=e("input[type=hidden]#uid").val();var i=[];var s=n.data("boxfull");if(r){i.push(r)}else{e("td.mail_selector input[type=checkbox]:checked").each(function(t,n){var r=e(n);i.push(r.val())})}var o=a("boxfull","INBOX");var u=a("query","ALL");var f=a("page","1");GLOBALS.last_request=e.ajax({url:"inc/mail_move.php",type:"POST",data:{uid:i.join("|"),target:s,mailbox:o}}).done(function(e){t()});e("#modal-content,#modal-background").removeClass("active")})});return false});e("ul.top-menu a.opt-mark-read").on("click",function(){var n=e(this);var r=e("input[type=hidden]#uid").val();var i=[];if(r){i.push(r)}else{e("td.mail_selector input[type=checkbox]:checked").each(function(t,n){var r=e(n);i.push(r.val())})}var o=a("boxfull","INBOX");var f=a("query","ALL");var l=a("page","1");GLOBALS.last_request=e.ajax({url:"inc/mail_seen.php",type:"POST",data:{uids:i.join("|"),mailbox:o}}).done(function(e){console.log(e);if(r){u("%");s()}else{t()}});return false});e("ul.top-menu a.opt-mark-unread").on("click",function(){var n=e(this);var r=e("input[type=hidden]#uid").val();var i=[];if(r){i.push(r)}else{e("td.mail_selector input[type=checkbox]:checked").each(function(t,n){var r=e(n);i.push(r.val())})}var o=a("boxfull","INBOX");var f=a("query","ALL");var l=a("page","1");GLOBALS.last_request=e.ajax({url:"inc/mail_unseen.php",type:"POST",data:{uids:i.join("|"),mailbox:o}}).done(function(e){console.log(e);if(r){u("%");s()}else{t()}});return false});e("ul.top-menu a.opt-restore").on("click",function(){var n=e("input[type=hidden]#uid").val();var r=[];if(n){r.push(n)}else{e("td.mail_selector input[type=checkbox]:checked").each(function(t,n){var i=e(n);r.push(i.val())})}var i=a("boxfull","INBOX");var s=a("query","ALL");var o=a("page","1");GLOBALS.last_request=e.ajax({url:"inc/mail_move.php",type:"POST",data:{uid:r.join("|"),target:"INBOX",mailbox:i}}).done(function(e){t()});return false});e("ul.top-menu a.opt-spam").on("click",function(){var n=e("input[type=hidden]#uid").val();var r=[];if(n){r.push(n)}else{e("td.mail_selector input[type=checkbox]:checked").each(function(t,n){var i=e(n);r.push(i.val())})}var i=a("boxfull","INBOX");var s=a("query","ALL");var o=a("page","1");GLOBALS.last_request=e.ajax({url:"inc/mail_move.php",type:"POST",data:{uid:r.join("|"),target:"INBOX.Junk",mailbox:i}}).done(function(e){t()});return false});e("ul.top-menu a.opt-empty").on("click",function(){var t=a("box","INBOX");var n=a("boxfull","INBOX");var r=a("query","ALL");var i=a("page","1");if(t.match(/^(trash|junk)$/i)){GLOBALS.last_request=e.ajax({url:"inc/mail_erase_box.php",type:"POST",data:{boxfull:n}}).done(function(e){if(e){console.log(e)}u("%");s();o(t,r,i)})}return false});e("ul.top-menu a.opt-new").on("click",function(){GLOBALS.lock_keep_alive=true;if(GLOBALS.last_request){GLOBALS.last_request.abort();GLOBALS.last_request=null;if(e("body img.loading").length){e("body img.loading").remove()}}e("div.container ul.top-menu.active").removeClass("active").css("display","none");e("div.container ul.top-menu.new").addClass("active").css("display","");var n=a("box","INBOX");var r=a("boxfull","INBOX");var i=a("query","ALL");var s=a("page","1");var o=sessionStorage.uid?sessionStorage.uid:0;var u="";var l=sessionStorage.type;switch(sessionStorage.type){case"draft":u="";break;case"forward":u="FWD: ";break;case"response":default:u="RE: "}e("div.stage").html('<input type="hidden" id="message_type" value="'+u.replace(/\s+|:/i,"").toLowerCase()+'" /><div id="email-editor" style="margin: 0 auto;"></div>');e("#email-editor").append('<label for="subject">Assunto: </label><input type="text" name="subject" id="subject" size="120" value="'+(sessionStorage.title?u+sessionStorage.title:"")+'" /><br />');e("#email-editor").append('<input type="button" id="send" value="Enviar" />');e("#email-editor").append('<input type="button" id="cancel" value="Cancelar" />');e("#email-editor").append('<textarea class="ckeditor" name="email_body" id="email_body">'+(sessionStorage.body?sessionStorage.body:"")+"</textarea>");var c="";if(sessionStorage.attachments){var h=sessionStorage.attachments.split(",");for(var p=0;p<h.length;++p){h[p]='<span class="att_item">'+h[p]+'<img src="assets/img/delete.png" width="10" height="10"></span>'}c=h.join("\n<br />\n")}e("nav.sidebar").html(['<label for="to">Para </label><br /><ul id="to" style="width: 93%;" multiple/>','<label for="cc">Cc </label><br /><ul id="cc" style="width: 93%;" multiple/>','<label for="cco">Cco </label><br /><ul id="cco" style="width: 93%;" multiple/>','<form action="inc/enviar_arquivo.php" name="formUpload" id="formUpload" method="post" enctype="multipart/form-data">','    <label>Anexos <br /><input type="file" name="attachment" id="attachment" size="45" /></label>',"    <br />",'    <progress value="0" max="100"></progress><span id="porcentagem">0%</span>',"</form>","<br />",'<div id="attachments_list">'+c+"</div>"].join("\n"));e("input#attachment").on("change",function(){e("#formUpload").ajaxForm({uploadProgress:function(t,n,r,i){e("progress").attr("value",i);e("#porcentagem").html(i+"%")},success:function(t){e("progress").attr("value","100");e("#porcentagem").html("100%");if(t.sucesso==true){e("div#attachments_list").append('<span class="att_item">'+t.msg.replace(/^uploads\//,"")+' <img src="assets/img/delete.png" width="10" height="10" /></span><br />');e("progress").attr("value","0");e("#porcentagem").html("0%");e("div#attachments_list span img").on("click",function(){var t=e(this);t.parent("span.att_item").next("br").remove();t.parent("span.att_item").remove()})}else{console.log("Fail: "+t.msg)}},error:function(){e("#resposta").html("Erro ao enviar requisição!")},dataType:"json",url:"inc/enviar_arquivo.php",resetForm:true}).submit()});e("nav.sidebar #to").tagit({tagsChanged:function(){e("li.tagit-choice").each(function(t,n){var r=e(n);if(!r.attr("tagvalue")){r.attr("tagvalue",r.find(".tagit-label").text());r.removeAttr("tagit-type-none");r.removeClass("tagit-type-none")}})},minLength:3,initialTags:sessionStorage.sender?JSON.parse(sessionStorage.sender):[],tagSource:function(t,n){GLOBALS.last_request=e.ajax({url:"inc/list_contacts.php",type:"POST",dataType:"json",data:{pattern:t.term.split(/,\s*/).pop()},success:function(t){n(e.map(t.results,function(e){return{label:e.name,value:e.email}}))}})}});e("nav.sidebar #cc").tagit({minLength:3,initialTags:sessionStorage.cc?JSON.parse(sessionStorage.cc):[],tagSource:function(t,n){GLOBALS.last_request=e.ajax({url:"inc/list_contacts.php",type:"POST",dataType:"json",data:{pattern:t.term.split(/,\s*/).pop()},success:function(t){n(e.map(t.results,function(e){return{label:e.name,value:e.email}}))}})}});e("nav.sidebar #cco").tagit({minLength:3,tagSource:function(t,n){GLOBALS.last_request=e.ajax({url:"inc/list_contacts.php",type:"POST",dataType:"json",data:{pattern:t.term.split(/,\s*/).pop()},success:function(t){n(e.map(t.results,function(e){return{label:e.name,value:e.email}}))}})}});e("div.stage #email-editor input[type=button]#send").on("click",function(){var t=[];var n=[];var r=[];var i=e("div.stage div#email-editor input#subject").val();var s=e("div.cke_inner iframe").contents().find("body").html();var u=[];e("div#attachments_list span").each(function(){var t=e(this);u.push("uploads/"+t.text().replace(/^\s+|\s+$/g,""))});u=u.join("|");e("#to li").each(function(n,r){t.push(e(r).attr("tagvalue"))});t=t.join(",");e("#cc li").each(function(t,r){n.push(e(r).attr("tagvalue"))});n=n.join(",");e("#cco li").each(function(t,n){r.push(e(n).attr("tagvalue"))});r=r.join(",");GLOBALS.last_request=e.ajax({url:"inc/sendmail.php",type:"POST",data:{recipients:t,recipients_cc:n,recipients_cco:r,subject:i,email_body:s,attachments:u}}).done(function(t,n,r){if(o!=0){GLOBALS.last_request=e.ajax({url:"inc/register_reply.php",data:{uid:o,action:e("#message_type").val()},type:"POST",dataType:"json"})}if(t==="success"){window.location.reload()}}).fail(function(e,t,n){alert("Erro ao enviar email.")})});e("div.stage #email-editor input[type=button]#cancel").on("click",function(){t()});CKEDITOR.replace("email_body",{toolbar:[["Cut","Copy","Paste","PasteText","PasteFromWord","-","Undo","Redo"],["Bold","Italic","Underline","Strike","Subscript","Superscript","-","RemoveFormat"],["NumberedList","BulletedList","-","Outdent","Indent","-","Blockquote","-","JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock","-","BidiLtr","BidiRtl"],["Format"]]});var d=sessionStorage.last_draft_uid;sessionStorage.clear();sessionStorage.setItem("last_draft_uid",d);sessionStorage.setItem("email_action",l);GLOBALS.cron_save_draft=setInterval(f,1e3*60*5);e("ul.top-menu a.opt-save-draft").on("click",function(){f()});return false});e("ul.top-menu a.opt-forward").on("click",function(){var t=e("div.email_header a.mail-from").prev("span.name").text().replace(/['"]/g,"");var n=e("div.email_header a.mail-from").text().replace(/['"]/g,"");var r=e("div.email_header h1:first").text();var i=e("#uid").val();var s=[];e("div.attachments ul li a").each(function(){var t=e(this);s.push(t.attr("title").replace(/\s+\([^\)]*\)$/i,""))});s.join("|");t=t?t:n;var o=JSON.stringify([{label:t,value:n}]);var u='<br /><br /><blockquote style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex">'+e("div.email-body").html()+"</blockquote>";sessionStorage.setItem("uid",i);sessionStorage.setItem("type","forward");sessionStorage.setItem("title",r);sessionStorage.setItem("body",u);sessionStorage.setItem("attachments",s);e("ul.top-menu a.opt-new").trigger("click")});e("ul.top-menu a.opt-response").on("click",function(){var t=e("div.email_header a.mail-from").prev("span.name").text().replace(/['"]/g,"");var n=e("div.email_header a.mail-from").text().replace(/['"]/g,"");var r=e("div.email_header h1:first").text();var i=e("#uid").val();var s=[];e("div.attachments ul li a").each(function(){var t=e(this);s.push(t.attr("title").replace(/\s+\([^\)]*\)$/i,""))});s.join("|");t=t?t:n;var o=JSON.stringify([{label:t,value:n}]);var u='<br /><br /><blockquote style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex">'+e("div.email-body").html()+"</blockquote>";sessionStorage.setItem("uid",i);sessionStorage.setItem("title",r);sessionStorage.setItem("body",u);sessionStorage.setItem("attachments",s);if(t&&n){sessionStorage.setItem("sender",o)}e("ul.top-menu a.opt-new").trigger("click")});e("ul.top-menu a.opt-response-all").on("click",function(){var t=e("#uid").val();var n=e("div.email_header h1:first").text();var r=[];var i=[];var s='<br /><br /><blockquote style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex">'+e("div.email-body").html()+"</blockquote>";var o=[];e("div.attachments ul li a").each(function(){var t=e(this);o.push(t.attr("title").replace(/\s+\([^\)]*\)$/i,""))});o.join("|");e("div.email_header a.mail-to, div.email_header a.mail-from").each(function(t,n){var i=e(this);var s=i.prev("span.name").text().replace(/['"]/g,"");var o=i.text().replace(/['"]/g,"");var u=e("#self_mail").val();s=s?s:o;if(o!=u){if(s&&o){r.push({label:s,value:o})}}});r=JSON.stringify(r);e("div.email_header a.mail-cc").each(function(t,n){var r=e(this);var s=r.prev("span.name").text().replace(/['"]/g,"");var o=r.text().replace(/['"]/g,"");s=s?s:o;if(s&&o){i.push({label:s,value:o})}});i=JSON.stringify(i);sessionStorage.setItem("uid",t);sessionStorage.setItem("title",n);sessionStorage.setItem("sender",r);sessionStorage.setItem("cc",i);sessionStorage.setItem("body",s);sessionStorage.setItem("attachments",o);e("ul.top-menu a.opt-new").trigger("click")});e("#email_search").on("keyup",function(t){var n=e(this);var r=n.val();var i=a("box","Inbox");var s=a("page","1");if(t.which==8||t.which>=65&&t.which<=90||t.which>=96&&t.which<=105){if(r){var u="SUBJECT "+r;o(i,u,s)}}if(!r){o(i,"ALL",s)}});e("#contact_search").on("keyup",function(){var t=e(this);var n=t.val();if(n){u(n)}else{u("%")}});e("nav.contatos a.add_contact").on("click",function(){e("div.stage").html(['<div class="contact_info">','   <input type="hidden" name="original_mail" value="" />','   <label for="contact_name">Nome</label><br /><input type="text" name="contact_name" id="contact_name" size="60" value="" /><br />','   <label for="contact_email">Email</label><br /><input type="text" name="contact_email" id="contact_email" size="60" value="" /><br />','   <label for="contact_addr">Endereço</label><br /><input type="text" name="contact_addr" id="contact_addr" size="100" value="" /><br />','   <input type="button" name="save" value="Salvar" />','   <input type="button" name="cancel" value="Cancelar" />',"</div>"].join("\n"));e("div.stage input[name=save]").on("click",function(){var n=e("input#contact_name").val();var r=e("input#contact_email").val();var i=e("input#contact_addr").val();GLOBALS.last_request=e.ajax({url:"inc/contact_add.php",type:"POST",data:{name:n,email:r,address:i}}).done(function(){t()})});e("div.stage input[name=cancel]").on("click",function(){t()});return false});e("nav.pastas a.add_mailbox").on("click",function(){e("div.stage").html(['<div class="folder_add">','   <label for="folder_parent">Inserir pasta </label><br /><select name="folder_parent" id="folder_parent"></select><br />','   <label for="folder_name">Nome da pasta </label><br /><input type="text" name="folder_name" id="folder_name" size="31" value="" /><br />','   <input type="button" name="save" value="Salvar" />','   <input type="button" name="cancel" value="Cancelar" />',"</div>"].join("\n"));GLOBALS.last_request=e.ajax({url:"inc/request_to_buffer.php",type:"POST",dataType:"json",data:{where:"list_mailboxes"},beforeSend:function(){r()}}).done(function(t){r();var n=t.mailboxes;var i=['<option value="">Nenhuma</option>'];for(var s=0,o=0;s<n.length;++s,++o){var u=n[s].mailbox;n[s].mailbox=n[s].mailbox.replace(/inbox/i,"Inbox").replace(/inbox\./i,"").replace(/\./i,"/");if(n[s].mailbox.match(/^drafts$/i)||n[s].mailbox.match(/^sent$/i)){++o;continue}var a=n[s].mailbox.replace(/^inbox$/i,"Entrada").replace(/^trash$/i,"Lixeira").replace(/^sent$/i,"Enviados").replace(/^junk$/i,"Spam");i.push('<option value="'+u+'">'+a+"</option>")}e("select#folder_parent").html(i)});e("div.stage input[name=save]").on("click",function(){var n=e("input#folder_name").val();var r=e("select#folder_parent").val();GLOBALS.last_request=e.ajax({url:"inc/mailbox_add.php",type:"POST",data:{name:n,parent:r},dataType:"json"}).done(function(){t()})});e("div.stage input[name=cancel]").on("click",function(){t()});return false});e("nav.pastas a.delete_mailbox").on("click",function(){e("div.stage").html(['<div class="folder_add">','   <label for="folder_parent">Pasta </label><br /><select name="folder" id="folder"></select><br />','   <input type="button" name="delete" value="Deletar" />','   <input type="button" name="cancel" value="Cancelar" />',"</div>"].join("\n"));GLOBALS.last_request=e.ajax({url:"inc/request_to_buffer.php",type:"POST",dataType:"json",data:{where:"list_mailboxes"},beforeSend:function(){r()}}).done(function(t){r();var n=t.mailboxes;var i=['<option value="">Nenhuma</option>'];for(var s=0,o=0;s<n.length;++s,++o){var u=n[s].mailbox;n[s].mailbox=n[s].mailbox.replace(/inbox/i,"Inbox").replace(/inbox\./i,"").replace(/\./i,"/");if(n[s].mailbox.match(/^drafts$/i)||n[s].mailbox.match(/^sent$/i)){++o;continue}var a=n[s].mailbox.replace(/^inbox$/i,"Entrada").replace(/^trash$/i,"Lixeira").replace(/^sent$/i,"Enviados").replace(/^junk$/i,"Spam");i.push('<option value="'+u+'">'+a+"</option>")}e("select#folder").html(i)});e("div.stage input[name=delete]").on("click",function(){var n=e("select#folder").val();GLOBALS.last_request=e.ajax({url:"inc/mailbox_delete.php",type:"POST",data:{folder:n}}).done(function(){t()})});e("div.stage input[name=cancel]").on("click",function(){t()});return false});e("nav.pastas a.update_mailbox").on("click",function(){e("div.stage").html(['<div class="contact_info">','<label for="mailboxe_name">Selecionar pasta: </label><br /><select id="mailboxe_name"  name="mailboxe_name"></select><br />','   <input type="hidden" name="original_mail" value="" />','   <label for="mailboxe_rename">Renomear para</label><br /><input type="text" name="mailboxe_rename" id="mailboxe_rename" size="60" value="" /><br />','   <input type="button" name="update_mailbox" value="Salvar" />','   <input type="button" name="cancel" value="Cancelar" />',"</div>"].join("\n"));GLOBALS.last_request=e.ajax({url:"inc/request_to_buffer.php",type:"POST",dataType:"json",data:{where:"list_mailboxes"},beforeSend:function(){r()}}).done(function(t){r();var n=t.mailboxes;var i=[];for(var s=0,o=0;s<n.length;++s,++o){var u=n[s].mailbox;n[s].mailbox=n[s].mailbox.replace(/inbox/i,"Inbox").replace(/inbox\./i,"").replace(/\./i,"/");if(n[s].mailbox.match(/^drafts$/i)||n[s].mailbox.match(/^sent$/i)){++o;continue}var a=n[s].mailbox.replace(/^inbox$/i,"Entrada").replace(/^trash$/i,"Lixeira").replace(/^sent$/i,"Enviados").replace(/^junk$/i,"Spam");i.push('<option value="'+u+'">'+a+"</option>")}e("select#mailboxe_name").html(i)});e("div.stage input[name=update_mailbox]").on("click",function(){var n=e("select#mailboxe_name").val();var r=e("input#mailboxe_rename").val();GLOBALS.last_request=e.ajax({url:"inc/update_mailboxe.php",type:"POST",data:{old_name:n,rename:r}}).done(function(e){t()})});e("div.stage input[name=cancel]").on("click",function(){t()});return false})})})(jQuery)