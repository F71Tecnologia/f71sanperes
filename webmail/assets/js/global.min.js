var GLOBALS={cron_save_draft:null,cron_keep_alive:null,lock_keep_alive:false,last_request:null,user_config:null};(function(e){function t(){window.location="?box=Inbox&boxfull=INBOX"}function n(t){e("#modal-content,#modal-background").addClass("active");e("#modal-content").addClass("active").html(t);e("#modal-background").on("click",function(){e("#modal-content,#modal-background").removeClass("active")})}function r(){e("#modal-background").click()}function i(){var t=e("#modal-background");if(t.hasClass("active")){t.removeClass("active");return}t.addClass("active")}function s(){if(e("div.email_preview").length)e("div.email_preview").remove()}function o(){return!!e("div.email_preview").length}function u(){if(e("body img.loading").length){e("body img.loading").remove()}else{e("body").prepend('<img class="loading" src="assets/img/ajax-loader.gif" style="left: 60%; top: 37%; position: absolute; z-index: 100;" />')}}function a(){e("body").prepend('<img class="successful" src="assets/img/successful.png" style="left: 60%; top: 37%; position: absolute; z-index: 100;" />');setInterval(function(){if(e("body img.successful").length){e("body img.successful").remove()}},3e3)}function f(){e("body").prepend('<img class="error" src="assets/img/delete.png" style="left: 60%; top: 37%; position: absolute; z-index: 100;" />');setInterval(function(){if(e("body img.error").length){e("body img.error").remove()}},3e3)}function l(e){if(!e)return;var t=JSON.parse(e);GLOBALS.user_config=t;return!!GLOBALS.user_config?true:false}function c(t){if(!t)return;var n=h(t);var r="";GLOBALS.last_request=e.ajax({url:n,type:"GET",dataType:"HTML",async:false}).done(function(e){r=p(e)}).fail(function(){});return r}function h(e){if(!e)return undefined;return"inc/user_config/"+e.replace(/\W+?/g,"_")+"_config.json"}function p(e){if(!e)return;return e.replace(/[\\]+?/g,"").replace(/([a-z0-9]+\s*\=\s*)\"(.+?)\"/gi,RegExp.$1+"'"+RegExp.$2+"'");}function d(){var t=e("#self_mail").val();if(!t)return;var n=c(t);if(n)return l(n)?true:false;console.log("pass can not set user config");return false}function v(){return GLOBALS.user_config?GLOBALS.user_config:false}function m(){var e=v();if(e.production_mode){g()}else{t()}}function g(){var t=e("div.email_header input#uid").val();GLOBALS.last_request=e.ajax({url:"inc/get_next_uid.php",type:"POST",data:{uid:t},dataType:"json",beforeSend:function(){u()}}).done(function(e){u();if(e.error){alert("Não existe próximo email.")}else{if(e.new_uid){var t=e.new_uid;var n=T("boxfull",T("box","Inbox"));b(t,n)}}})}function y(){var t=e("div.email_header input#uid").val();GLOBALS.last_request=e.ajax({url:"inc/get_prev_uid.php",type:"POST",data:{uid:t},dataType:"json",beforeSend:function(){u()}}).done(function(e){u();if(e.error){alert("Não existe email anterior.")}else{if(e.new_uid){var t=e.new_uid;var n=T("boxfull",T("box","Inbox"));b(t,n)}}})}function b(t,n,r,i){sessionStorage.removeItem("title");sessionStorage.removeItem("sender");sessionStorage.removeItem("body");sessionStorage.removeItem("cc");e("div.container ul.top-menu.active").removeClass("active").css("display","none");e("div.container ul.top-menu.email").addClass("active").css("display","");GLOBALS.last_request=e.ajax({url:"inc/dump_body.php",type:"POST",data:{mailbox:n,email_uid:t},dataType:"html",beforeSend:function(){u()}}).done(function(t){u();var n=T("box","Inbox");if(n.match(/^drafts$/i)){e("body").append('<div id="draft_content" style="display: hidden;" />');var s=e("div#draft_content");s.html(t);var o=e("#uid").val();var a=s.find("div.email_header h1:first").text();var f=[];var l=[];var c=s.find("div.email-body").html();var h=[];s.find("div.attachments ul li a").each(function(){var t=e(this);h.push(t.attr("title").replace(/\s+\([^\)]*\)$/i,""))});h.join("|");s.find("div.email_header a.mail-to, div.email_header a.mail-from").each(function(t,n){var r=e(this);var i=r.prev("span.name").text().replace(/['"]/g,"");var s=r.text().replace(/['"]/g,"");var o=e("#self_mail").val();i=i?i:s;if(s!=o){if(i&&s){f.push({label:i,value:s})}}});f=JSON.stringify(f);s.find("div.email_header a.mail-cc").each(function(t,n){var r=e(this);var i=r.prev("span.name").text().replace(/['"]/g,"");var s=r.text().replace(/['"]/g,"");i=i?i:s;if(i&&s){l.push({label:i,value:s})}});l=JSON.stringify(l);sessionStorage.setItem("uid",o);sessionStorage.setItem("type","draft");sessionStorage.setItem("title",a);sessionStorage.setItem("sender",f);sessionStorage.setItem("cc",l);sessionStorage.setItem("body",c);sessionStorage.setItem("attachments",h);s.remove();e("a.opt-new").trigger("click");return}if(typeof r==="undefined"){r="div.stage"}e(r).html(['<div class="printable" style="padding-left: 5px;">',t,"</div>"].join("\n"));if(typeof i==="function")i();e("div.email_header img.email_up").on("click",function(){g()});e("div.email_header img.email_down").on("click",function(){y()});e("div.email_header span.email a").on("click",function(){var t=e(this);var n=t.text();var r=t.prev("span.name").text()||n;var i=confirm("Adicionar "+r+" aos contatos?");if(i){GLOBALS.last_request=e.ajax({url:"inc/contact_add.php",type:"POST",data:{name:r,email:n,address:"",user_email:e("#self_mail").val()}}).done(function(e){if(e&&e.match(/^Error/i)){alert(e)}x()})}return false});e("a.mail-to, a.mail-from, a.mail-cc, a.mail-cco").prop("title","Incluir Contato")});return false}function w(t){if(t===undefined)t=false;var n=t&&t.from_server?"dump_mailboxes":"read_mailbox_from_file";GLOBALS.last_request=e.ajax({url:"inc/list_mailboxes.php",type:"POST",dataType:"json",data:{dump_mailboxes:n},beforeSend:function(){u()}}).done(function(t){u();var n=t.mailboxes_tree;var r=t.mailboxes;var i=T("box","Inbox");e("div.container nav.sidebar .sidebar-pastas").html(traverse(n,"lista_pastas"));e("#lista_pastas").treeview({collapsed:true})})}function E(n){GLOBALS.last_request=e.ajax({url:"inc/list_mailboxes.php",type:"POST",data:{dump_mailboxes:"dump_mailboxes",no_response:true}}).done(function(){if(n.go_home)t()})}function S(n,r,i,s){var o=T("boxfull","INBOX");if(o.match(/^INBOX.Inbox$/gi)){t()}n=n?n:T("box","Inbox");r=r?r:T("query","ALL");i=i?i:T("page","1");if(n.match(/^drafts$/i)){e("div.container ul.top-menu.active").removeClass("active").css("display","none");e("div.container ul.top-menu.drafts").addClass("active").css("display","")}if(n.match(/^trash$/i)){e("div.container ul.top-menu.active").removeClass("active").css("display","none");e("div.container ul.top-menu.trash").addClass("active").css("display","")}if(n.match(/^junk$/i)){e("div.container ul.top-menu.active").removeClass("active").css("display","none");e("div.container ul.top-menu.spam").addClass("active").css("display","")}var a="";var f="";if(s&&s.query&&s.order){a=s.query;f=s.order}GLOBALS.last_request=e.ajax({url:"inc/request_to_buffer.php",data:{where:"list_emails",search_query:r,box:n,boxfull:o,page:i,sort_query:a,sort_order:f},type:"POST",dataType:"json",beforeSend:function(){u()},error:function(e,t,n){console.error("Error Status: "+t);console.error(e.statusText);console.error(e.responseText);console.error(e.status)}}).done(function(t){var n=T("box","Inbox");var r=t.emails;var i=t.pagination;u();if(!r.length){e("div.stage").html('<span class="no-result">Nada encontrado.</span>');return false}if(n.match(/^drafts$/i)||n.match(/^sent$/i)){e("div.stage").html(['<table class="mail_list sent_list" cellspacing="0">',"   <thead>","       <tr>",'           <td><input type="checkbox" class="select_all" /></td>','           <td data-column="subject" class="subject">Assunto</td>','           <td data-column="recipient" class="recipient">Destinatário</td>',"           <td></td>",'           <td data-column="date" class="date">Data</td>',"       </tr>","   </thead>","   <tbody>","   </tbody>","</table>",'<div style="clear: both;"></div>','<div class="usage"><b>'+t.percent_usage+"% de espaço em uso</b> ("+t.quota_info+")</div>",'<div class="pagination"></div>'].join("\n"))}else{e("div.stage").html(['<table class="mail_list main_list" cellspacing="0">',"   <thead>","       <tr>",'           <td><input type="checkbox" class="select_all" /></td>','           <td data-column="subject" class="subject">Assunto</td>','           <td data-column="sender" class="sender">Remetente</td>',"           <td></td>","           <td></td>",'           <td data-column="date" class="date">Data</td>',"       </tr>","   </thead>","   <tbody>","   </tbody>","</table>",'<div style="clear: both;"></div>','<div class="usage"><b>'+t.percent_usage+"% de espaço em uso</b> ("+t.quota_info+")</div>",'<div class="pagination"></div>'].join("\n"))}var s="";if(t.order_by&&t.order){var o=e("table.mail_list");if(t.order_by=="SORTFROM"){t.order_by="sender"}else if(t.order_by=="SORTTO"){t.order_by="recipient"}else if(t.order_by=="SORTSUBJECT"){t.order_by="subject"}else if(t.order_by=="SORTDATE"){t.order_by="date"}o.attr("data-orderby",t.order_by);o.attr("data-order",t.order);var a=t.order=="desc"?"column-order-down":"column-order-up";e("table.mail_list thead tr td").removeClass("column-order-up column-order-down");e("table.mail_list thead tr td."+t.order_by).append("<div />").addClass(a)}e("div.stage div.pagination").html("").append(i);for(var f=0,l=0;f<r.length;++f,l=l?0:1){var c=r[f];var h=[];var p=c.from;var d="";if(c.from!=null)c.from=c.from.replace(/\s+&lt;.*$/i,"").replace(/('|"|&quot;)/g,"");if(c.from!=null&&c.from.length>30){c.from=c.from.substr(0,27);if(c.from.match(/\.$/i))c.from+="..";else c.from+="..."}if(n.match(/^drafts$/i)||n.match(/^sent$/i)){h=['<tr class="'+c.li_class+'" '+(l?'style="background: #f3f3f3;"':"")+" >",'    <td class="mail_selector" style="padding: 1px; width: 25px;"><input type="checkbox" value="'+c.uid+'"></td>','    <td class="mail_subject"><a href="#" uid="'+c.uid+'" number="'+c.number+'">'+c.subject+"</a></td>",'    <td class="mail_to">'+(c.to?c.to:"(Sem destinatário)")+"</td>",'    <td class="mail_has_att">'+(c.has_reply?'<img src="assets/img/reply.png" style="margin-bottom: -4px" title="Respondido" width="16" />':"")+" "+(c.has_rw?'<img src="assets/img/rw.png" style="position: relative; top: 2px;" title="E-mail já foi encaminhado" width="16" />':"")+""+(c.has_att?'<img src="assets/img/attachment.png" title="E-mail com anexo" width="20" style="margin-bottom: -4px; margin-right:5px"/>':"")+"</td>",'    <td class="mail_date">'+c.date+"</td>","</tr>"].join("\n")}else{h=['<tr class="'+c.li_class+'" '+(l?'style="background: #f3f3f3;"':"")+" >",'    <td class="mail_selector" style="padding: 1px; width: 25px;"><input type="checkbox" value="'+c.uid+'"></td>','    <td class="mail_subject" title="'+d+'"><a href="#" uid="'+c.uid+'" number="'+c.number+'">'+c.subject+"</a></td>",'    <td class="mail_from" title="'+p+'">'+c.from+"</td>","    <td>"+(c.has_reply?'<img src="assets/img/reply.png" style="margin-bottom: -4px" title="Respondido" width="16" />':"")+" "+(c.has_rw?'<img src="assets/img/rw.png" style="position: relative; top: 2px;" title="E-mail já foi encaminhado" width="16" />':"")+"</td>",'    <td class="mail_has_att">'+(c.has_att?'<img src="assets/img/attachment.png"  title="E-mail com anexo" width="20" style="margin-bottom: -4px; margin-right:5px" />':"")+"</td>",'    <td class="mail_date">'+c.date+"</td>","</tr>"].join("\n")}e("div.stage table.mail_list tbody").append(e(h))}e("div.stage table.mail_list thead :checkbox").on("change",function(){var t=e(this).is(":checked");e("div.stage table.mail_list tbody :checkbox").each(function(e,n){n.checked=t})});e("div.stage table.mail_list thead tr td").on("click",function(){var t=e(this);var n=e("table.mail_list");var r=t.data("column");var i=e("#email_search").val();var s={query:"",order:""};if(typeof r==="undefined")return;if(n.data("orderby")==r){s.order=n.data("order")=="desc"?"asc":"desc"}else{s.order="asc"}switch(r){case"sender":s.query="SORTFROM";break;case"recipient":s.query="SORTTO";break;case"subject":s.query="SORTSUBJECT";break;case"date":s.query="SORTDATE";break}if(i){i="SUBJECT "+i}else{i="ALL"}S(false,i,false,s)});(function(){var t=700;var n=0;var r=null;e("div.stage table.mail_list tr td.mail_subject a").on("click",function(){var i=e(this);n++;var s=v();if(n===1&&s.preview_include){e("td.mail_selector input[type=checkbox]:checked").each(function(){e(this).prop("checked","")});r=setTimeout(function(){var t=i.attr("uid");var r=T("boxfull",T("box","Inbox"));e('<div class="email_preview"></div>').insertAfter("div.stage");u();b(t,r,"div.email_preview",function(){e("div.email_preview").find("img.email_up").remove();e("div.email_preview").find("img.email_down").remove();e("div.email_preview").find("div.email_link_back").remove();e("div.email_preview").prepend('<div class="resize_indicator"></div>');e("div.email_preview").prepend(['<div class="auto_resizer">','           <div class="small"></div>','           <div class="medium"></div>','           <div class="big"></div>',"</div>"].join("\n"));e("div.email_preview").prepend('<img class="preview_close" src="assets/img/delete.png" style="width: 15px; height: 15px; margin: 3px; cursor: pointer;">');e("div.email_preview img.preview_close").on("click",function(){e("div.email_preview").remove();e("div.container ul.top-menu.active").removeClass("active").css("display","none");e("div.container ul.top-menu.principal").addClass("active").css("display","")});if(s.preview_redimensionavel){e("div.email_preview").resizable({minHeight:200,maxHeight:680,maxWidth:920,minWidth:675,ghost:false,handles:"n, w, nw",resize:function(){e(this).css("top","");e(this).css("left","")}})}u()});n=0},t)}else{clearTimeout(r);var o=i.attr("uid");var a=T("boxfull",T("box","Inbox"));e("div.email_preview").remove();b(o,a);n=0}}).on("dblclick",function(e){e.preventDefault()})})()})}function x(t){if(typeof t==undefined)t=".";GLOBALS.last_request=e.ajax({url:"inc/contacts_list.php",data:{pattern:t,user_email:e("#self_mail").val()},type:"POST",dataType:"json"}).done(function(t){var i=[];if(e("ul#lista_contatos"))e("ul#lista_contatos").remove();if(t.results.length){i.push('<ul id="lista_contatos">');for(var s=0;s<t.results.length;++s){var o=t.results[s].name;t.results[s].name=t.results[s].name.length>=25&&t.results[s].name.match(/(^.{0,19})/gi)?RegExp.$1+"...":t.results[s].name;var a=["<li>",'   <a href="#" class="contact left" title="'+t.results[s].email+'" data-email="'+t.results[s].email+'" data-name="'+o+'">','       <img src="assets/img/contact.png"/>',"       <span>"+t.results[s].name+"</span>","   </a>",'   <img class="contact_send_mail right" src="assets/img/email.png" title="Enviar email para '+t.results[s].email+'" width="auto" height="20" />','   <div class="clear"></div>',"</li>"].join("\n");i.push(a)}i.push("</ul>")}else{i.push("<span>Nenhum contato</span>")}e("nav.sub-sidebar.sidebar-contatos").html(i.join("\n"));e("nav.sub-sidebar.sidebar-contatos ul li img.contact_send_mail").on("click",function(){var t=e(this);var n=t.siblings("a.contact").data("email");var r=t.siblings("a.contact").data("name");var i=JSON.stringify([{label:r,value:n}]);if(r&&n){sessionStorage.setItem("sender",i)}e("ul.top-menu a.opt-new").trigger("click")});e("nav.sub-sidebar.sidebar-contatos ul a.contact").on("click",function(){var t=e(this);var i=t.data("email");GLOBALS.last_request=e.ajax({url:"inc/contact_info.php",data:{contact_email:i,user_email:e("#self_mail").val()},dataType:"json",type:"POST",beforeSend:function(){u()}}).done(function(t){u();if(t){n(['<div class="contact_info">',"   <h2>Editar Contato</h2>",'   <input type="hidden" name="original_mail" value="'+t.email+'" />','   <label for="contact_name">Nome</label><br /><input type="text" name="contact_name" id="contact_name" size="60" value="'+t.name+'" /><br />','   <label for="contact_email">Email</label><br /><input type="text" name="contact_email" id="contact_email" size="60" value="'+t.email+'" /><br />','   <label for="contact_addr">Endereço</label><br /><input type="text" name="contact_addr" id="contact_addr" size="100" value="'+t.address+'" /><br />','   <input type="button" name="save" value="Salvar" />','   <input type="button" name="cancelar" value="Cancelar" />','   <input type="button" name="delete" value="Deletar" class="right"/>','   <div class="clear"></div>',"</div>"].join("\n"));e("div.contact_info input[name='delete']").on("click",function(){var t=e("input#contact_email").val();GLOBALS.last_request=e.ajax({url:"inc/contact_delete.php",type:"POST",data:{contact_email:t,user_email:e("#self_mail").val()},beforeSend:function(){u()}}).done(function(){u();x();r()})});e("div.contact_info input[name='save']").on("click",function(){var t=e("input[name=original_mail]").val();var n=e("input#contact_name").val();var i=e("input#contact_email").val();var s=e("input#contact_addr").val();GLOBALS.last_request=e.ajax({url:"inc/contact_save_info.php",type:"POST",dataType:"JSON",data:{user_email:e("#self_mail").val(),original_mail:t,contact_name:n,contact_email:i,contact_addr:s},beforeSend:function(){u()}}).done(function(t){u();if(t){e("input#contact_email").focus()}x();r()})});e("div.contact_info input[name='cancelar']").on("click",function(){r()})}});return false})})}function T(e,t){t=t!=="undefined"?t:null;var n=decodeURI((RegExp(e+"="+"(.+?)(&|$)").exec(location.search)||[,t])[1]);return n==="null"?null:n}function N(){try{var t=[];var n=[];var r=[];var i=e("div.stage div#email-editor input#subject").val();var s=e("div.cke_inner iframe").contents().find("body").html();var o=[];e("div#attachments_list span").each(function(){o.push("uploads/"+e(this).text().replace(/^\s+|\s+$/g,""))});o=o.join("|");e("#to li").each(function(n,r){t.push(e(r).attr("tagvalue"))});t=t.join(",");e("#cc li").each(function(t,r){n.push(e(r).attr("tagvalue"))});n=n.join(",");e("#cco li").each(function(t,n){r.push(e(n).attr("tagvalue"))});r=r.join(",");GLOBALS.last_request=e.ajax({url:"inc/save_draft.php",type:"POST",dataType:"json",data:{recipients:t,recipients_cc:n,recipients_cco:r,subject:i,email_body:s,attachments:o}}).done(function(t){if(t.draft_uid){var n=t.draft_uid;if(sessionStorage.last_draft_uid){GLOBALS.last_request=e.ajax({url:"inc/mail_delete.php",type:"POST",data:{permanent:true,maillist:sessionStorage.last_draft_uid,boxfull:"INBOX.Drafts"},dataType:"json"}).done(function(e){sessionStorage.setItem("last_draft_uid",n)})}else{sessionStorage.setItem("last_draft_uid",n)}}})}catch(u){console.log(u)}}window.load_emails=S;e(document).ready(function(){GLOBALS.cron_keep_alive=setInterval(function(){GLOBALS.last_request=e.ajax({url:"inc/imap_connection.php",type:"GET"});if(!GLOBALS.lock_keep_alive){S(false,false,false)}},1e3*60*5);e("nav.sidebar").resizable({ghost:false,minWidth:197,maxWidth:260});e(document).tooltip({hide:{effect:"blind",duration:70},show:{effect:"blind",duration:70}});(function(){S(false,false,false);x();w();d()})();(function(){jQuery.support.placeholder=function(){var e=document.createElement("input");return"placeholder"in e}();if(!e.support.placeholder){e("[placeholder]").focus(function(){var t=e(this);if(t.val()===t.attr("placeholder")){t.val("");t.removeClass("placeholder")}}).blur(function(){var t=e(this);if(t.val()===""||t.val()===t.attr("placeholder")){t.addClass("placeholder");t.val(t.attr("placeholder"))}}).blur()}})();(function(){var t=v();if(t)return;var n=['<div style="width: 200px; height: 105px;">',"   Você ainda não escolheu suas preferencias de usabilidade nem criou uma assinatura de email<br/><p>Clique aqui para escolher suas preferencias.<br/>Obrigado!</p>","</div>"].join("\n");e(".config-button").balloon({contents:n,position:"bottom"});e(".config-button").first().mouseover();setTimeout(function(){e(".config-button").hideBalloon()},9e3)})();e("ul.top-menu a.opt-print").on("click",function(){var t=window.open("","p_window");var n=!confirm("Incluir anexos na impressão?")?"div.attachments{display: none !important;}":"";var r=e(".email_header > h1:nth-child(2)","div.stage").text();var i=["<!doctype htmfl>","<html>","   <head>","       <title>"+r+"</title>",'       <style type="text/css">@media print{body{width:800px;height:100%;margin:0;padding:0;font-size:13px;font-family:Tahoma,Geneva,sans-serif}div.email_header{width:90%;color:#2b2b2b;margin-bottom:30px}div.email_header h1{font-size:16px}div.email_header span{margin-right:20px}div.email_header span.date{float:right;text-align:right;font-weight:700}div.email_header span.time{float:right;text-align:right;font-weight:700}div.email_header div.header-separator{width:100%;padding:5px 0;margin-bottom:20px;border-bottom:2px solid #595959}div.email_header span.email span{margin:0}div.pagination{padding:10px;position:fixed;bottom:38px}div.pagination a{padding:2px 5px;margin:2px;text-decoration:none;color:#2f75fa}div.pagination a:hover,div.pagination a:active{border-bottom:1px solid #2f75fa;color:#000}div.pagination span.current{padding:2px 5px;margin:2px;border:1px solid #2f75fa;font-weight:700;background-color:#2f75fa;color:#fff}div.pagination span.disabled{padding:2px 5px;margin:2px;color:#000}div.email_header div.attachments{margin:10px 0 -16px}div.email_header div.attachments ul{margin:0;padding:0;width:800px}div.email_header div.attachments ul li{list-style:none;margin-left:auto;margin-right:auto;display:inline-block}div.email_header div.attachments ul li a{display:inline-block;text-decoration:none;color:#000;text-align:center}div.email_header div.attachments ul li a img{float:left;width:100px;width:100px}div.email_header div.attachments ul li a p{clear:both;font-size:12px;font-family:Tahoma,Geneva,sans-serif}'+n+"}</style>","   </head>","   <body>",e("div.stage").html(),"   </body>","</html>"].join("\n");t.document.write(i);t.print();t.close()});e("ul.top-menu a.opt-delete").on("click",function(){var n=e("input[type=hidden]#uid").val();var i=[];if(n){i.push(n)}else{e("td.mail_selector input[type=checkbox]:checked").each(function(t,n){var r=e(n);i.push(r.val())})}var s=T("box","INBOX");var o=T("boxfull","INBOX");var a=T("query","ALL");var f=T("page","1");var l=s.match(/^(trash|junk)$/i)?"1":"0";GLOBALS.last_request=e.ajax({url:"inc/mail_delete.php",type:"POST",data:{permanent:l,maillist:i.join(","),box:s,boxfull:o},dataType:"json",beforeSend:function(){r();u()}}).done(function(e){u();if(e.errors){alert(e.errors+" emails não foram excluidos.")}else{t()}});return false});e("ul.top-menu a.opt-move").on("click",function(){s();var i=!!e("td.mail_selector input[type=checkbox]:checked").size();var o=!!e("input[type=hidden]#uid").val();if(!(i||o)){alert("Selecione um ou mais emails ou abra o email que desejar mover.");return}n(['<div class="move_mailbox_content">','<div class="mailboxes_container"></div>  ',"</div>"].join("\n"));GLOBALS.last_request=e.ajax({url:"inc/list_mailboxes.php",type:"POST",dataType:"json",data:{dump_mailboxes:"read_mailbox_from_file"}}).done(function(n){var i=n.mailboxes_tree;var s=n.mailboxes;var o=T("box","Inbox");e(".mailboxes_container").html(traverse(i,"folder_list",true));e("#folder_list").treeview({collapsed:true});e("#folder_list li a").on("click",function(){var n=e(this);var i=e("input[type=hidden]#uid").val();var s=[];var o=n.data("box");var u=false;if(i){u=true;s.push(i)}else{e("td.mail_selector input[type=checkbox]:checked").each(function(t,n){var r=e(n);s.push(r.val())})}var l=T("boxfull","INBOX");var c=T("query","ALL");var h=T("page","1");GLOBALS.last_request=e.ajax({url:"inc/mail_move.php",type:"POST",data:{uid:s.join("|"),target:o,mailbox:l},beforeSend:function(){r()}}).done(function(){a()}).fail(function(){f()}).always(function(){if(u){m()}else{t()}})})});return false});e("ul.top-menu a.opt-mark-read").on("click",function(){var n=e(this);var r=e("input[type=hidden]#uid").val();var i=[];if(r){i.push(r)}else{e("td.mail_selector input[type=checkbox]:checked").each(function(t,n){var r=e(n);i.push(r.val())})}var s=T("boxfull","INBOX");var o=T("query","ALL");var u=T("page","1");GLOBALS.last_request=e.ajax({url:"inc/mail_seen.php",type:"POST",data:{uids:i.join("|"),mailbox:s}}).done(function(e){if(r){x();w()}else{t()}});return false});e("ul.top-menu a.opt-mark-unread").on("click",function(){var n=e(this);var r=e("input[type=hidden]#uid").val();var i=[];if(r){i.push(r)}else{e("td.mail_selector input[type=checkbox]:checked").each(function(t,n){var r=e(n);i.push(r.val())})}var s=T("boxfull","INBOX");var o=T("query","ALL");var u=T("page","1");GLOBALS.last_request=e.ajax({url:"inc/mail_unseen.php",type:"POST",data:{uids:i.join("|"),mailbox:s}}).done(function(e){console.log(e);if(r){x();w()}else{t()}});return false});e("ul.top-menu a.opt-restore").on("click",function(){var n=e("input[type=hidden]#uid").val();var r=[];if(n){r.push(n)}else{e("td.mail_selector input[type=checkbox]:checked").each(function(t,n){var i=e(n);r.push(i.val())})}var i=T("boxfull","INBOX");var s=T("query","ALL");var o=T("page","1");GLOBALS.last_request=e.ajax({url:"inc/mail_move.php",type:"POST",data:{uid:r.join("|"),target:"INBOX",mailbox:i}}).done(function(e){t()});return false});e("ul.top-menu a.opt-spam").on("click",function(){var n=e("input[type=hidden]#uid").val();var r=[];if(n){r.push(n)}else{e("td.mail_selector input[type=checkbox]:checked").each(function(t,n){var i=e(n);r.push(i.val())})}var i=T("boxfull","INBOX");var s=T("query","ALL");var o=T("page","1");GLOBALS.last_request=e.ajax({url:"inc/mail_move.php",type:"POST",data:{uid:r.join("|"),target:"INBOX.Junk",mailbox:i}}).done(function(e){t()});return false});e("ul.top-menu a.opt-empty").on("click",function(){var t=T("box","INBOX");var n=T("boxfull","INBOX");var r=T("query","ALL");var i=T("page","1");if(t.match(/^(trash|junk)$/i)){GLOBALS.last_request=e.ajax({url:"inc/mail_erase_box.php",type:"POST",data:{boxfull:n}}).done(function(e){if(e){console.log(e)}x();w();S(t,r,i)})}return false});e("ul.top-menu a.opt-new").on("click",function(){GLOBALS.lock_keep_alive=true;if(GLOBALS.last_request){GLOBALS.last_request.abort();GLOBALS.last_request=null;if(e("body img.loading").length){e("body img.loading").remove()}}e("div.container ul.top-menu.active").removeClass("active").css("display","none");e("div.container ul.top-menu.new").addClass("active").css("display","");var n=T("box","INBOX");var r=T("boxfull","INBOX");var i=T("query","ALL");var s=T("page","1");var o=sessionStorage.uid?sessionStorage.uid:0;var u="";var a=sessionStorage.type;switch(sessionStorage.type){case"draft":u="";break;case"forward":u="FWD: ";break;case"response":default:u="RE: "}var f=v();var l=f.include_assinatura?strRepeat("<br/>",4)+f.assinatura:"";e("div.stage").html('<input type="hidden" id="message_type" value="'+u.replace(/\s+|:/i,"").toLowerCase()+'" /><div id="email-editor" style="margin: 0 auto;"></div>');e("#email-editor").append('<label for="subject">Assunto: </label><input type="text" name="subject" id="subject" size="120" value="'+(sessionStorage.title?u+sessionStorage.title:"")+'" /><br />');e("#email-editor").append('<input type="button" id="send" value="Enviar" />');e("#email-editor").append('<input type="button" id="cancel" value="Cancelar" />');e("#email-editor").append('<textarea class="ckeditor" name="email_body" id="email_body">'+(sessionStorage.body?sessionStorage.body:"")+l+"</textarea>");var c="";if(sessionStorage.attachments){var h=sessionStorage.attachments.split("|");for(var p=0;p<h.length;++p){h[p]='<span class="att_item">'+h[p]+'<img src="assets/img/delete.png" width="10" height="10"></span>'}c=h.join("\n<br />\n")}e("nav.sidebar").html(['<label for="to">Para </label><br /><ul id="to" style="width: 93%;" multiple/>','<label for="cc">Cc </label><br /><ul id="cc" style="width: 93%;" multiple/>','<label for="cco">Cco </label><br /><ul id="cco" style="width: 93%;" multiple/>','<form action="inc/enviar_arquivo.php" name="formUpload" id="formUpload" method="post" enctype="multipart/form-data">','    <label>Anexos <br /><input type="file" name="attachment" id="attachment" size="45" /></label>',"    <br />",'    <progress value="0" max="100"></progress><span id="porcentagem">0%</span>',"</form>","<br />",'<div id="attachments_list">'+c+"</div>"].join("\n"));e("div#attachments_list span img").on("click",function(){var t=e(this);t.parent("span.att_item").next("br").remove();t.parent("span.att_item").remove()});e("input#attachment").on("change",function(){e("#formUpload").ajaxForm({uploadProgress:function(t,n,r,i){e("progress").attr("value",i);e("#porcentagem").html(i+"%")},success:function(t){e("progress").attr("value","100");e("#porcentagem").html("100%");if(t.sucesso==true){e("div#attachments_list").append('<span class="att_item">'+t.msg.replace(/^uploads\//,"")+' <img src="assets/img/delete.png" width="10" height="10" /></span><br />');e("progress").attr("value","0");e("#porcentagem").html("0%");e("div#attachments_list span img").on("click",function(){var t=e(this);t.parent("span.att_item").next("br").remove();t.parent("span.att_item").remove()})}else{console.log("Fail: "+t.msg)}},error:function(){e("#resposta").html("Erro ao enviar requisição!")},dataType:"json",url:"inc/enviar_arquivo.php",resetForm:true}).submit()});e("nav.sidebar #to").tagit({tagsChanged:function(){e("li.tagit-choice").each(function(t,n){var r=e(n);if(!r.attr("tagvalue")){r.attr("tagvalue",r.find(".tagit-label").text());r.removeAttr("tagit-type-none");r.removeClass("tagit-type-none")}})},minLength:3,initialTags:sessionStorage.sender?JSON.parse(sessionStorage.sender):[],tagSource:function(t,n){GLOBALS.last_request=e.ajax({url:"inc/contacts_list.php",type:"POST",dataType:"json",data:{pattern:t.term.split(/,\s*/).pop(),user_email:e("#self_mail").val()},success:function(t){n(e.map(t.results,function(e){return{label:e.name,value:e.email}}))}})}});e("nav.sidebar #cc").tagit({minLength:3,initialTags:sessionStorage.cc?JSON.parse(sessionStorage.cc):[],tagSource:function(t,n){GLOBALS.last_request=e.ajax({url:"inc/contacts_list.php",type:"POST",dataType:"json",data:{pattern:t.term.split(/,\s*/).pop(),user_email:e("#self_mail").val()},success:function(t){n(e.map(t.results,function(e){return{label:e.name,value:e.email}}))}})},tagsChanged:function(){e("li.tagit-choice").each(function(t,n){var r=e(n);if(!r.attr("tagvalue")){r.attr("tagvalue",r.find(".tagit-label").text());r.removeAttr("tagit-type-none");r.removeClass("tagit-type-none")}})}});e("nav.sidebar #cco").tagit({minLength:3,tagSource:function(t,n){GLOBALS.last_request=e.ajax({url:"inc/contacts_list.php",type:"POST",dataType:"json",data:{pattern:t.term.split(/,\s*/).pop(),user_email:e("#self_mail").val()},success:function(t){n(e.map(t.results,function(e){return{label:e.name,value:e.email}}))}})},tagsChanged:function(){e("li.tagit-choice").each(function(t,n){var r=e(n);if(!r.attr("tagvalue")){r.attr("tagvalue",r.find(".tagit-label").text());r.removeAttr("tagit-type-none");r.removeClass("tagit-type-none")}})}});e("div.stage #email-editor input[type=button]#send").on("click",function(){var t=[];var n=[];var r=[];var i=e("div.stage div#email-editor input#subject").val();var s=e("div.cke_inner iframe").contents().find("body").html();var u=[];e("div#attachments_list span").each(function(){var t=e(this);var n=t.text();var r;n=n.replace(/^\s+?|\s+?$/,"");if(n.match(/\.([a-z0-9]+)$/i)){r=RegExp.$1;n=n.replace(/\.[a-z0-9]+$/i,"")}n+=".";n+=r;u.push("uploads/"+n)});u=u.join("|");e("#to li").each(function(n,r){t.push(e(r).attr("tagvalue"))});t=t.join(",");e("#cc li").each(function(t,r){n.push(e(r).attr("tagvalue"))});n=n.join(",");e("#cco li").each(function(t,n){r.push(e(n).attr("tagvalue"))});r=r.join(",");GLOBALS.last_request=e.ajax({url:"inc/sendmail.php",type:"POST",data:{recipients:t,recipients_cc:n,recipients_cco:r,subject:i,email_body:s,attachments:u},beforeSend:function(){e("#modal-background").addClass("active")}}).done(function(t,n,r){if(o!=0){GLOBALS.last_request=e.ajax({url:"inc/register_reply.php",async:false,data:{uid:o,action:e("#message_type").val()},type:"POST",dataType:"json"})}if(t==="success"){window.location.reload()}}).fail(function(e,t,n){alert("Erro ao enviar email.")})});e("div.stage #email-editor input[type=button]#cancel").on("click",function(){t()});CKEDITOR.replace("email_body",{toolbar:null});var d=sessionStorage.last_draft_uid;sessionStorage.clear();sessionStorage.setItem("last_draft_uid",d);sessionStorage.setItem("email_action",a);GLOBALS.cron_save_draft=setInterval(N,1e3*60*5);e("ul.top-menu a.opt-save-draft").on("click",function(){N()});return false});e("ul.top-menu a.opt-forward").on("click",function(){var t=e("div.email_header a.mail-from").prev("span.name").text().replace(/['"]/g,"");var n=e("div.email_header a.mail-from").text().replace(/['"]/g,"");var r=e("div.email_header h1:first").text();var i=e("#uid").val();var s=[];e("div.attachments ul li a").each(function(){var t=e(this);s.push(t.attr("title").replace(/\s+\([^\)]*\)$/i,""))});s=s.join("|");t=t?t:n;var o=JSON.stringify([{label:t,value:n}]);var u='<br /><br /><blockquote style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex">'+e("div.email-body").html()+"</blockquote>";sessionStorage.setItem("uid",i);sessionStorage.setItem("type","forward");sessionStorage.setItem("title",r);sessionStorage.setItem("body",u);sessionStorage.setItem("attachments",s);e("ul.top-menu a.opt-new").trigger("click")});e("ul.top-menu a.opt-response").on("click",function(){var t=e("div.email_header a.mail-from").prev("span.name").text().replace(/['"]/g,"");var n=e("div.email_header a.mail-from").text().replace(/['"]/g,"");var r=e("div.email_header h1:first").text();var i=e("#uid").val();t=t?t:n;var o=JSON.stringify([{label:t,value:n}]);var u='<br /><br /><blockquote style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex">'+e("div.email-body").html()+"</blockquote>";sessionStorage.setItem("uid",i);sessionStorage.setItem("title",r);sessionStorage.setItem("body",u);if(t&&n){sessionStorage.setItem("sender",o)}s();e("ul.top-menu a.opt-new").trigger("click")});e("ul.top-menu a.opt-response-all").on("click",function(){var t=e("#uid").val();var n=e("div.email_header h1:first").text();var r=[];var i=[];var o='<br /><br /><blockquote style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex">'+e("div.email-body").html()+"</blockquote>";e("div.email_header a.mail-to, div.email_header a.mail-from").each(function(t,n){var i=e(this);var s=i.prev("span.name").text().replace(/['"]/g,"");var o=i.text().replace(/['"]/g,"");var u=e("#self_mail").val();s=s?s:o;if(o!=u){if(s&&o){r.push({label:s,value:o})}}});r=JSON.stringify(r);e("div.email_header a.mail-cc").each(function(t,n){var r=e(this);var s=r.prev("span.name").text().replace(/['"]/g,"");var o=r.text().replace(/['"]/g,"");s=s?s:o;if(s&&o){i.push({label:s,value:o})}});i=JSON.stringify(i);sessionStorage.setItem("uid",t);sessionStorage.setItem("title",n);sessionStorage.setItem("sender",r);sessionStorage.setItem("cc",i);sessionStorage.setItem("body",o);s();e("ul.top-menu a.opt-new").trigger("click")});e("#email_search").on("keyup",function(t){var n=e(this);var r=n.val();var i=T("box","Inbox");var s=T("page","1");if(t.which==8||t.which>=65&&t.which<=90||t.which>=96&&t.which<=105){if(r){var o="SUBJECT "+r;S(i,o,s)}}if(!r){S(i,"ALL",s)}});e("#contact_search").on("keyup",function(t){var n=e(this);var r=n.val();if(t.keyCode!=13&&r!="")return;if(r){x(r)}else{x()}});e("nav.contatos a.add_contact").on("click",function(){n(['<div class="contact_info">',"   <h2>Adicionar Contato</h2>",'   <input type="hidden" name="original_mail" value="" />','   <label for="contact_name">Nome</label><br /><input type="text" name="contact_name" id="contact_name" size="60" value="" /><br />','   <label for="contact_email">Email</label><br /><input type="text" name="contact_email" id="contact_email" size="60" value="" /><br />','   <label for="contact_addr">Endereço</label><br /><input type="text" name="contact_addr" id="contact_addr" size="100" value="" /><br />','   <input type="button" name="save" value="Salvar" />','   <input type="button" name="cancel" value="Cancelar" />',"</div>"].join("\n"));e("div.contact_info input[type='text']#contact_name").focus();e("div.contact_info input[name='save']").on("click",function(){var t=e("input#contact_name").val();var n=e("input#contact_email").val();var i=e("input#contact_addr").val();GLOBALS.last_request=e.ajax({url:"inc/contact_add.php",type:"POST",dataType:"JSON",data:{name:t,email:n,address:i,user_email:e("#self_mail").val()}}).done(function(e){x();r()})});e("div.contact_info input[name='cancel']").on("click",function(){r()});return false});e("h2.folder_option").on("click",function(){n(['<div class="folder_area">',"       <h2>Opções de Pastas</h2>",'       <input type="hidden" id="folder_parent" /><br />','       <div class="add_controler">','           <a href="javascript:;" class="add_mailbox"><img src="assets/img/btn-add.png" width="auto" height="20" />Nova Pasta</a>','           <input class="create_area" id="get_name" type="text" />','           <input class="create_area" id="create_mailbox" type="button" value="Salvar" />',"       </div>",'       <div class="mailboxes_container"></div>','       <input type="button" name="cancel" value="Fechar" />',"</div>"].join("\n"));e("div.folder_area input[type='text']#folder_name").focus();GLOBALS.last_request=e.ajax({url:"inc/list_mailboxes.php",type:"POST",dataType:"json",data:{dump_mailboxes:"read_mailbox_from_file"},beforeSend:function(){u()}}).done(function(t){var n=t.mailboxes_tree;var s=t.mailboxes;var o=T("box","Inbox");e(".mailboxes_container").html(traverse(n,"folder_list",true,true));e("#folder_list").treeview({collapsed:true});u();e("#folder_list li a").on("click",function(){e("#folder_parent").val(e(this).data("box"));e("#show_folder").text(e(this).data("box_name"))});e("div.folder_area img#folder_del").on("click",function(){var t=e(this).siblings("a").data("box");r();GLOBALS.last_request=e.ajax({url:"inc/mailbox_delete.php",type:"POST",async:false,data:{folder:t},beforeSend:function(){i();u()}}).done(function(){w({from_server:true});i();u()}).fail(function(){f()})});e("div.folder_area img#folder_edit").on("click",function(){var t=e(this);var n=t.siblings("a");if(n.find("input").length){n.text(n.data("box_name"));return}e("div.folder_area img#folder_edit").each(function(){var t=e(this).siblings("a").data("box_name");e(this).siblings("a").text(t)});var s=['<input id="rename"     type="text"/>','<input id="do_rename"   type="button" value="Ok"/>'].join("\n");n.text("");n.html(s);e("input#rename").focus();e("div.folder_area input#do_rename").on("click",function(){var t=e(this);var n=t.siblings("input#rename").val();var s=t.parents("a").data("box");t.parents("a").text(n);GLOBALS.last_request=e.ajax({url:"inc/update_mailboxe.php",type:"POST",data:{old_name:s,rename:n},beforeSend:function(){r();i();u()}}).done(function(e){w({from_server:true});i();u();a()})})})});e("div.folder_area a.add_mailbox").on("click",function(){e(".create_area").toggle()});e("div.folder_area input#create_mailbox").on("click",function(){var t=e("#get_name").val();var n=e("#folder_parent").val();if(!t){alert("Nomeie a pasta a ser criada");return}GLOBALS.last_request=e.ajax({url:"inc/mailbox_add.php",type:"POST",data:{name:t,parent:n},dataType:"json",beforeSend:function(){r();i();u()}}).done(function(){w({from_server:true});u();i();a()}).fail(function(){f()})});e("div.folder_area input[name=cancel]").on("click",function(){r()});return false});e("a.config-button").on("click",function(){u();GLOBALS.last_request=e.ajax({url:"inc/user_config/config.php",type:"POST",dataType:"HTML",data:{json_config:c(e("#self_mail").val())},beforeSend:function(){u()}}).done(function(t){n(t);CKEDITOR.replace("assinatura",{toolbar:[{name:"basicstyles",groups:["basicstyles","cleanup"],items:["Bold","Italic","Underline","Strike","Subscript","-","RemoveFormat"]},{name:"links",items:["Link","Unlink","Anchor"]},"/",{name:"styles",items:["Styles","Format","Font","FontSize"]},{name:"colors",items:["TextColor","BGColor"]}],mode:"wysiwyg"});e("div.config_content input[type='button']#save").on("click",function(){var t=e("div.config_content");var n={preview_include:t.find("input#preview_include").prop("checked"),preview_redimensionavel:t.find("input#preview_redimensionavel").prop("checked"),production_mode:t.find("input#production_mode").prop("checked"),include_assinatura:t.find("input#include_assinatura").prop("checked"),assinatura:e(e(".cke_wysiwyg_frame")[0].contentDocument).find("body").html()};var i=JSON.stringify(n);var s=e("#self_mail").val();GLOBALS.last_request=e.ajax({url:"inc/user_config.php",type:"POST",dataType:"JSON",data:{config:i,email:s},beforeSend:function(){r();u()}}).done(function(e){jsonConfigSanitized=e.replace(/[\\]+?/g,"");l(jsonConfigSanitized);u();a()}).fail(function(){u();f()})});e("div.config_content input[type='button']#cancel").on("click",function(){r()});e("div input[type='checkbox']#preview_include").on("click",function(){if(e(this).prop("checked")=="checked"){e("div input[type='checkbox']#preview_redimensionavel").prop("disabled","");return}e("div input[type='checkbox']#preview_redimensionavel").prop("disabled","disabled")})}).fail(function(){console.log("drop here")});})})})(jQuery)