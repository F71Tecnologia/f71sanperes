(function(e){e.fn.autoGrowInput=function(t){t=e.extend({maxWidth:1e3,minWidth:0,comfortZone:70},t);this.filter("input:text").each(function(){var n=t.minWidth||e(this).width(),r="",i=e(this),s=e("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:i.css("fontSize"),fontFamily:i.css("fontFamily"),fontWeight:i.css("fontWeight"),letterSpacing:i.css("letterSpacing"),whiteSpace:"nowrap"}),u=function(){if(r===(r=i.val())){return}var e=r.replace(/&/g,"&").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");s.html(e);var u=s.width(),a=u+t.comfortZone>=n?u+t.comfortZone:n,f=i.width(),l=a<f&&a>=n||a>n&&a<t.maxWidth;if(l){var c=i.attr("style");i.css("cssText","width: "+a+"px !important;"+c)}};s.insertAfter(i);e(this).bind("keyup keydown blur update",u)});return this}})(jQuery);(function(e){e.widget("custom.catcomplete",e.ui.autocomplete,{_renderMenu:function(t,n){var r=this,i="";e.each(n,function(e,n){if(n.category&&n.category!=i){t.append("<li class='ui-autocomplete-category'>"+n.category+"</li>");i=n.category}r._renderItemData(t,n)})}});e.widget("ui.tagit",{options:{tagSource:[],triggerKeys:["enter","space","comma","tab","semicolon"],seperatorKeys:["comma","semicolon"],initialTags:[],defaultType:"none",minLength:1,autocompleteMinLength:1,select:false,allowNewTags:true,caseSensitive:false,sortable:false,editable:false,highlightOnExistColor:"#0F0",emptySearch:true,tagsChanged:function(e,t,n){},maxTags:undefined,blurOnPaste:true},_splitAt:/\ |,/g,_existingAtIndex:0,_keys:{backspace:[8],enter:[13],space:[32],comma:[44,188],tab:[9],semicolon:[59,186]},_sortable:{sorting:-1},_idEditing:false,_create:function(){var t=this;this.tagsArray=[];this.timer=null;this.lastKey=0;this.element.addClass("tagit");this.element.children("li").each(function(){var n=e(this);var r=n.attr("tagValue")||n.data("value");t.options.initialTags.push({label:n.text(),value:r?r:n.text()})});pushRegex=function(r,i,s){if(e.inArray(i,t.options.seperatorKeys)!=-1){n.push(s)}};t._splitAt=null;var n=[];pushRegex(n,"space",/\ /);pushRegex(n,"semicolon",/;/);pushRegex(n,"comma",/,/);var r=e.map(n,function(e){return e.source}).join("|");t._splitAt=new RegExp(r,"g");this.element.html('<li class="tagit-new"><input class="tagit-input" type="text" /></li>');this.input=this.element.find(".tagit-input");this.input.autoGrowInput();e(this.element).click(function(n){if(e(n.target).hasClass("tagit-close")){var r=e(n.target).parent();var i=t.tagsArray[r.index()];i.element.remove();t._popTag(i)}else{if(!t._isEditing){t.input.focus()}if(t.options.emptySearch&&e(n.target).hasClass("tagit-input")&&t.input.val()==""&&t.input.catcomplete!=undefined){t.input.catcomplete("search")}if(t.options.editable&&e(n.target).hasClass("tagit-label")){t._edit(n.target)}}});var i=this.options.select;var s=this.options.minLength;this.options.appendTo=this.element;this.options.source=this.options.tagSource;this.options.select=function(e,n){t.input.data("autoCompleteTag",true);clearTimeout(t.timer);if(t.options.maxTags!==undefined&&t.tagsArray.length==t.options.maxTags){t.input.val("")}else{if(n.item.label===undefined)t._addTag({label:n.item.value});else t._addTag({label:n.item.label,value:n.item.value,type:n.item.category})}return false},this.options.focus=function(e,n){if(n.item.label!==undefined&&/^key/.test(e.originalEvent.type)){t.input.val(n.item.label);t.input.data("value",n.item.value);return false}};this.options.autoFocus=!this.options.allowNewTags;this.options.minLength=this.options.autocompleteMinLength;this.input.catcomplete(this.options);this.options.minLength=s;this.options.select=i;t.isKeyEventProcessed=false;this.input.keyup(function(e){t.isKeyEventProcessed=false});this.input.keydown(function(e){t._processKeyEvent(e)});this.input.keypress(function(e){t._processKeyEvent(e)});this.input.bind("paste",function(n){if(t.options.blurOnPaste){var r=e(this);t.timer=setTimeout(function(){r.blur()},0)}});this.input.blur(function(n){t.currentLabel=e(this).val();t.currentValue=e(this).data("value");if(t.options.allowNewTags){t.timer=setTimeout(function(){t._addTag({label:t.currentLabel,value:t.currentValue,type:t.options.defaultType});t.currentValue="";t.currentLabel=""},400)}e(this).val("").removeData("value");return false});if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}if(this.options.select){this.select=e('<select class="tagit-hiddenSelect" name="'+(this.element.attr("name")||this.element.data("name"))+'" multiple="multiple"></select>');this.element.after(this.select)}this._initialTags();if(t.options.sortable!==false){var o={items:".tagit-choice",containment:"parent",opacity:.6,tolerance:"pointer",start:function(n,r){t._sortable.tag=e(r.item);t._sortable.origIndex=t._sortable.tag.index()},update:function(e,n){t._sortable.newIndex=t._sortable.tag.index();t._moveTag(t._sortable.origIndex,t._sortable.newIndex);if(t.options.tagsChanged){var r=t.tagsArray[t._sortable.newIndex];t.options.tagsChanged(r.value,"moved",r.element)}}};if(t.options.sortable=="handle"){o.handle="a.ui-icon";o.cursor="move"}t.element.sortable(o)}},_processKeyEvent:function(e){if(this.isKeyEventProcessed){return}var t=e.which||e.keyCode||e.charCode;var n=this.element.children(".tagit-choice:last");this.isKeyEventProcessed=true;if(t==this._keys.backspace){return this._backspace(n)}if(this._isInitKey(t)&&!(this._isTabKey(t)&&this.value==""&&!this.input.data("autoCompleteTag"))){e.preventDefault();this.input.data("autoCompleteTag",false);if(!this.options.allowNewTags||this.options.maxTags!==undefined&&this.tagsArray.length==this.options.maxTags){this.input.val("")}else if(this.options.allowNewTags&&this.input.val().length>=this.options.minLength){this._addTag({label:this.input.val(),type:this.options.defaultType})}}if(this.options.maxLength!==undefined&&this.input.val().length>this.options.maxLength){e.preventDefault();this.input.val(this.input.val().substring(0,this.options.maxLength))}if(n.hasClass("selected"))n.removeClass("selected");this.lastKey=t},_postEdit:function(t,n,r){var i=e.proxy(function(){n.remove();e(t).removeClass("hidden");e(t).parent().removeClass("edited");this._isEditing=false},this);return function(){var s=e(t).parent().index();var o=this.tagsArray[s];var u=n.val();if(this._splitAt&&u.search(this._splitAt)>0){u=u.split(this._splitAt)[0]}if(u==r){i()}else if(this._addTag({label:u})){o.element.remove();this._popTag(o);var a=this.tagsArray.length-1;if(a!=s){var f=this.tagsArray[a];f.element.insertBefore(this.tagsArray[s].element);this._moveTag(this.tagsArray.length-1,s);if(this.options.tagsChanged){var l=this.tagsArray[s];this.options.tagsChanged(l.value,"moved",l.element)}}i()}}},_edit:function(t){this._isEditing=true;var n=e(t).text();var r=e("<input>");r.val(n);e(t).parent().addClass("edited");r.addClass("tagit-edit");r.css("width",e(t).outerWidth());e(t).addClass("hidden");r.blur(e.proxy(this._postEdit(t,r,n),this));r.keypress(e.proxy(function(e){var t=e.which||e.keyCode||e.charCode;if(this._isInitKey(t)){r.blur()}},this));e(t).before(r);r[0].select()},_popSelect:function(t){e("option:eq("+t.index+")",this.select).remove();this.select.change()},_addSelect:function(e){this.select.append('<option selected="selected" value="'+e.value+'">'+e.label+"</option>");this.select.change()},_popTag:function(e){if(e===undefined)e=this.tagsArray.pop();else this.tagsArray.splice(e.index,1);for(var t in this.tagsArray)this.tagsArray[t].index=t;if(this.options.select)this._popSelect(e);if(this.options.tagsChanged)this.options.tagsChanged(e?e.value||e.label:null,"popped",e);return},_addTag:function(t){if(t.label===undefined){t.label=t.value}this.input.catcomplete("close").val("");if(this._splitAt&&t.label.search(this._splitAt)>0){var n=t.label.split(this._splitAt);for(var r=0;r<n.length;r++)this._addTag({label:n[r],value:t.value});return}t.label=t.label.replace(/,+$/,"").trim();if(t.label=="")return false;t.label=t.label.replace(/&/g,"&").replace(/</g,"&lt;").replace(/>/g,"&gt;");var i=this._exists(t.label,t.value);if(i!==false){this._highlightExisting(i);return false}var s=this.tag(t.label,t.value,t.type);s.element=e('<li class="tagit-choice'+(t.type!==undefined?" tagit-type-"+t.type+'"':'"')+(t.value!==undefined?' tagValue="'+t.value+'"':"")+">"+(this.options.sortable=="handle"?'<a class="ui-icon ui-icon-grip-dotted-vertical" style="float:left"></a>':"")+'<div class="tagit-label">'+t.label+"</div>"+'<a class="tagit-close">x</a></li>');s.element.insertBefore(this.input.parent());this.tagsArray.push(s);this.input.val("");if(this.options.select)this._addSelect(s);if(this.options.tagsChanged)this.options.tagsChanged(s.label,"added",s.element);return true},_exists:function(e,t){if(this.tagsArray.length==0)return false;e=this._lowerIfCaseInsensitive(e);t=this._lowerIfCaseInsensitive(t);for(var n in this.tagsArray){if(this._lowerIfCaseInsensitive(this.tagsArray[n].label)==e){if(t!==undefined){if(this._lowerIfCaseInsensitive(this.tagsArray[n].value)==t)return n}else{return n}}}return false},_highlightExisting:function(e){if(this.options.highlightOnExistColor===undefined)return;var t=this.tagsArray[e];t.element.stop();var n=t.element.css("color");t.element.animate({color:this.options.highlightOnExistColor},100).animate({color:n},800,null,function(){t.element.attr("style","")})},_isInitKey:function(t){var n="";for(var r in this._keys)if(e.inArray(t,this._keys[r])!=-1)n=r;if(e.inArray(n,this.options.triggerKeys)!=-1)return true;return false},_isTabKey:function(t){var n=this._keys["tab"];return e.inArray(t,n)>-1},_removeTag:function(){this._popTag();this.element.children(".tagit-choice:last").remove()},_backspace:function(e){if(this.input.val()==""){if(this.lastKey==this._keys.backspace){this._popTag();e.remove();this.lastKey=null}else{e.addClass("selected");this.lastKey=this._keys.backspace}}return true},_initialTags:function(){var t=this;var n;if(this.options.tagsChanged)n=this.options.tagsChanged;this.options.tagsChanged=null;if(this.options.initialTags.length!=0){e(this.options.initialTags).each(function(e,n){if(typeof n=="object")t._addTag({label:n.label,value:n.value,type:n.type});else t._addTag({label:n})})}this.options.tagsChanged=n;this.options.tagsChanged(null,"tagsInited",null)},_lowerIfCaseInsensitive:function(e){if(e===undefined||typeof e!=typeof "a")return e;if(this.options.caseSensitive)return e;return e.toLowerCase()},_moveTag:function(t,n){this.tagsArray.splice(n,0,this.tagsArray.splice(t,1)[0]);for(var r in this.tagsArray)this.tagsArray[r].index=r;if(this.options.select){e("option:eq("+t+")",this.select).insertBefore(e("option:eq("+n+")",this.select))}},tags:function(){return this.tagsArray},destroy:function(){e.Widget.prototype.destroy.apply(this,arguments);clearTimeout(this.timer);this.tagsArray=[]},reset:function(){this.element.find(".tagit-choice").remove();this.tagsArray=[];if(this.options.select){this.select.children().remove();this.select.change()}this._initialTags();if(this.options.tagsChanged)this.options.tagsChanged(null,"reset",null)},fill:function(e){if(e!==undefined)this.options.initialTags=e;this.reset()},add:function(e,t){if(typeof e=="object")return this._addTag({label:e.label,value:e.value});else return this._addTag({label:e,value:t})},autocomplete:function(){return this.input.data("autocomplete")},tag:function(e,t,n,r){var i=this;return{label:e,value:t===undefined?e:t,type:n,element:r,index:i.tagsArray.length}},remove:function(e,t){if(this.tagsArray.length==0)return false;e=this._lowerIfCaseInsensitive(e);t=this._lowerIfCaseInsensitive(t);for(var n=0;n<this.tagsArray.length;n++){if(this._lowerIfCaseInsensitive(this.tagsArray[n].value)==t||this._lowerIfCaseInsensitive(this.tagsArray[n].label)==e){break}}if(n>=0&&n<this.tagsArray.length){var r=this.tagsArray[n];r.element.remove();this._popTag(r);return true}return false}})})(jQuery)