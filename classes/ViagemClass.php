<?phpclass ViagemClass {        public function getViagem() {        $usuario = carregaUsuario();        $id_user = $usuario['id_funcionario'];        $sql = "SELECT A.*, DATE_FORMAT(A.data, '%d/%m/%Y') AS data, DATE_FORMAT(A.data_ini, '%d/%m/%Y') AS data_ini, DATE_FORMAT(A.data_fim, '%d/%m/%Y') AS data_fim, A.nome AS nome_ree, B.nome AS nome_fun, A.status AS status                FROM viagem AS A                LEFT JOIN rh_clt AS B ON (A.id_user = B.id_clt)                WHERE A.status > 0";        $reemb = mysql_query($sql) or die(mysql_error());        return $reemb;    }    public function getFuncionarioId($id_fun){        $sql = "SELECT *                FROM funcionario                WHERE id_funcionario = '{$id_fun}'";        $fun = mysql_query($sql) or die(mysql_error());        $row = mysql_fetch_assoc($fun);        return $row;    }    public function getCltId($id){        $sql = "SELECT *                FROM rh_clt                WHERE id_clt = '{$id}'";        $fun = mysql_query($sql) or die(mysql_error());        $row = mysql_fetch_assoc($fun);        return $row;    }    public function getFuncionariosR() {        $sql = mysql_query("SELECT *                            FROM funcionario                            WHERE status_reg = '1' AND oculto = 0                            ORDER BY nome1");        $func = array("-1" => "« Selecione »");        while ($rst = mysql_fetch_assoc($sql)) {        $func[$rst['id_funcionario'].'///'.acentoMaiusculo($rst['nome1'])] = acentoMaiusculo($rst['nome1']);        }        return $func;    }    public function getCltR() {        $sql = mysql_query("SELECT id_clt, nome                            FROM rh_clt                            WHERE status_reg = '1' AND status NOT IN (SELECT codigo FROM rhstatus A WHERE A.tipo = 'recisao')                            ORDER BY nome");        $func = array("-1" => "« Selecione »");        while ($rst = mysql_fetch_assoc($sql)) {        $func[$rst['id_clt'].'///'.$rst['nome']] = $rst['nome'];        }        return $func;    }    public function cadViagem() {        $usuario = carregaUsuario();        $id_user = $usuario['id_funcionario'];        $id_projeto = $_REQUEST['id_projeto'];        $funcionario = $_REQUEST['funcionario'];            $valor = $_REQUEST['valor'];        $descricao = acentoMaiusculo($_REQUEST['descricao']);        $agencia = $_REQUEST['agencia'];        $conta = $_REQUEST['conta'];        $nomefavo = $_REQUEST['nomefavo'];        $cpf = $_REQUEST['cpf'];        $banco = $_REQUEST['banco'];        $dataT = date('Y-m-d H:i:s');            $data_cad = date('Y-m-d');                $data_ini = implode('-', array_reverse(explode('/', $_REQUEST['data_ini'])));        $data_fim = implode('-', array_reverse(explode('/', $_REQUEST['data_fim'])));        $trajeto = $_REQUEST['trajeto'];        $origem = $_REQUEST['origem'];        $destino = $_REQUEST['destino'];        $modelo = $_REQUEST['modelo'];        $placa = $_REQUEST['placa'];        $linha = $_REQUEST['linha'];        $tipo_meio_transporte = $_REQUEST['tipo_meio_transporte'];        $meio_transporte = $_REQUEST['meio_transporte'];        if($funcionario == 1){            $user_exp = explode("///", $_REQUEST['user']);            $user = $user_exp[0];            $nome = acentoMaiusculo($user_exp[1]);        }else{                    $nome = $_REQUEST['nome_razao'];        }        $valorF = str_replace(".","",$valor);        $valorF = str_replace(",",".",$valorF);        if (($nome == '')) {            $_SESSION['MESSAGE'] = "Verifique o campo Nome, ele não pode ser vazio";            $_SESSION['MESSAGE_COLOR'] = 'message-red';        } else {            if($meio_transporte == '9999') {                $sqlMeioTransporte = "INSERT INTO meio_transporte (`id_tipo_meio_transporte`, `placa`, `modelo`, `linha`) VALUES ('{$tipo_meio_transporte}', '{$placa}', '{$modelo}', '{$linha}');";                mysql_query($sqlMeioTransporte) or die(mysql_error());                $meio_transporte = mysql_insert_id();            }                        $insere_viagem = mysql_query("INSERT INTO viagem (id_usercad,data_cad,funcionario,id_user,nome,valor, DATA,descricao,banco,agencia,conta,favorecido,cpf, data_ini, data_fim, trajeto, id_meio_transporte, destino, origem, id_projeto) VALUES                 ('{$id_user}','{$data_cad}', '{$funcionario}', '{$user}','{$nome}', '{$valorF}', '{$dataT}', '{$descricao}', '{$banco}', '{$agencia}', '{$conta}', '{$nomefavo}', '{$cpf}', '{$data_ini}', '{$data_fim}', '{$trajeto}', '{$meio_transporte}', '{$destino}', '{$origem}', '{$id_projeto}')")                 or die(mysql_error());            $id_viagem = mysql_insert_id();                        if($id_viagem){                foreach ($_REQUEST['item'] as $key => $value) {                    $value['valor'] = str_replace(',', '.', str_replace('.', '', $value['valor']));                    $insertItem = "INSERT INTO viagem_itens_assoc (id_item, id_viagem, qtd, valor) VALUES ('{$value['id_item']}', '{$id_viagem}', '{$value['qtd']}', '{$value['valor']}');";                    mysql_query($insertItem) or die(mysql_error());                }            }            //dados usuario para cadastro de log            $local = "Financeiro - Viagem";            $ip = $_SERVER['REMOTE_ADDR'];            $acao = "Viagem Solicitado: ID: {$id_viagem}";            $id_usuario = $usuario['id_funcionario'];            $tipo_usuario = $usuario['tipo_usuario'];            $grupo_usuario = $usuario['grupo_usuario'];            $regiao = $usuario['id_regiao'];            $insere_log = mysql_query("INSERT INTO log (id_user, id_regiao, tipo_user, grupo_user, local, horario, ip, acao) VALUES                ('{$id_usuario}', '{$regiao}', '{$tipo_usuario}', '{$grupo_usuario}', '{$local}', NOW(), '{$ip}', '{$acao}')") or die(mysql_error());                              if ($insere_viagem && $insere_log) {                $_SESSION['MESSAGE'] = 'Informações gravadas com sucesso!';                $_SESSION['MESSAGE_COLOR'] = 'message-blue';                $_SESSION['MESSAGE_TYPE'] = 'info';                $_SESSION['regiao'] = $regiao;                $_SESSION['id_viagem'] = $id_viagem;                session_write_close();                header("refresh: 5;doc_solicitacao.php?id={$id_viagem}");            } else {                $_SESSION['MESSAGE'] = 'Erro ao cadastrar o viagem '.$id_viagem;                $_SESSION['MESSAGE_COLOR'] = 'message-red';                $_SESSION['regiao'] = $regiao;            }        }    }        public function editViagem() {        $usuario = carregaUsuario();        $id_user = $usuario['id_funcionario'];        $id_projeto = $_REQUEST['id_projeto'];        $funcionario = $_REQUEST['funcionario'];            $valor = $_REQUEST['valor'];        $descricao = acentoMaiusculo($_REQUEST['descricao']);        $agencia = $_REQUEST['agencia'];        $conta = $_REQUEST['conta'];        $nomefavo = $_REQUEST['nomefavo'];        $cpf = $_REQUEST['cpf'];        $banco = $_REQUEST['banco'];        $dataT = date('Y-m-d H:i:s');            $data_cad = date('Y-m-d');                $data_ini = implode('-', array_reverse(explode('/', $_REQUEST['data_ini'])));        $data_fim = implode('-', array_reverse(explode('/', $_REQUEST['data_fim'])));        $trajeto = $_REQUEST['trajeto'];        $origem = $_REQUEST['origem'];        $destino = $_REQUEST['destino'];        $modelo = $_REQUEST['modelo'];        $placa = $_REQUEST['placa'];        $linha = $_REQUEST['linha'];        $tipo_meio_transporte = $_REQUEST['tipo_meio_transporte'];        $meio_transporte = $_REQUEST['meio_transporte'];        if($funcionario == 1){            $user_exp = explode("///", $_REQUEST['user']);            $user = $user_exp[0];            $nome = acentoMaiusculo($user_exp[1]);        }else{                    $nome = $_REQUEST['nome_razao'];        }        $valorF = str_replace(".","",$valor);        $valorF = str_replace(",",".",$valorF);        if (($nome == '')) {            $_SESSION['MESSAGE'] = "Verifique o campo Nome, ele não pode ser vazio";            $_SESSION['MESSAGE_COLOR'] = 'message-red';        } else {            if($meio_transporte == '9999') {                $sqlMeioTransporte = "INSERT INTO meio_transporte (`id_tipo_meio_transporte`, `placa`, `modelo`, `linha`) VALUES ('{$tipo_meio_transporte}', '{$placa}', '{$modelo}', '{$linha}');";                mysql_query($sqlMeioTransporte) or die(mysql_error());                $meio_transporte = mysql_insert_id();            }            $id_viagem = $_REQUEST['id_viagem'];            $update_viagem = mysql_query("UPDATE viagem SET                id_usercad='{$id_user}',data_cad='{$data_cad}',funcionario='{$funcionario}',id_user='{$user}',nome='{$nome}',valor='{$valorF}', data='{$dataT}',descricao='{$descricao}',                banco='{$banco}',agencia='{$agencia}',conta='{$conta}',favorecido='{$nomefavo}',cpf='{$cpf}', data_ini='{$data_ini}', data_fim='{$data_fim}', trajeto='{$trajeto}',                 id_meio_transporte='{$meio_transporte}', destino='{$destino}', origem='{$origem}', id_projeto='{$id_projeto}' WHERE id_viagem = '{$id_viagem}' LIMIT 1;") or die(mysql_error());//            $id_viagem = mysql_insert_id();                        mysql_query("DELETE FROM viagem_itens_assoc WHERE id_viagem = '{$id_viagem}'");            if($id_viagem){                foreach ($_REQUEST['item'] as $key => $value) {                    $value['valor'] = str_replace(',', '.', str_replace('.', '', $value['valor']));                    $insertItem = "INSERT INTO viagem_itens_assoc (id_item, id_viagem, qtd, valor) VALUES ('{$value['id_item']}', '{$id_viagem}', '{$value['qtd']}', '{$value['valor']}');";                    mysql_query($insertItem) or die(mysql_error());                }            }            //dados usuario para cadastro de log            $local = "Financeiro - Viagem";            $ip = $_SERVER['REMOTE_ADDR'];            $acao = "Viagem edição: ID: {$id_viagem}";            $id_usuario = $usuario['id_funcionario'];            $tipo_usuario = $usuario['tipo_usuario'];            $grupo_usuario = $usuario['grupo_usuario'];            $regiao = $usuario['id_regiao'];            $insere_log = mysql_query("INSERT INTO log (id_user, id_regiao, tipo_user, grupo_user, local, horario, ip, acao) VALUES                ('{$id_usuario}', '{$regiao}', '{$tipo_usuario}', '{$grupo_usuario}', '{$local}', NOW(), '{$ip}', '{$acao}')") or die(mysql_error());                              if ($update_viagem && $insere_log) {                $_SESSION['MESSAGE'] = 'Informações gravadas com sucesso!';                $_SESSION['MESSAGE_COLOR'] = 'message-blue';                $_SESSION['MESSAGE_TYPE'] = 'info';                $_SESSION['regiao'] = $regiao;                $_SESSION['id_viagem'] = $id_viagem;                session_write_close();                header("Location: doc_solicitacao.php?id={$id_viagem}");            } else {                $_SESSION['MESSAGE'] = 'Erro ao cadastrar o viagem '.$id_viagem;                $_SESSION['MESSAGE_COLOR'] = 'message-red';                $_SESSION['regiao'] = $regiao;            }        }    }        public function getViagemByStatus($status = [1]) {        $result = "        SELECT             A.*, date_format(A.data, '%d/%m/%Y') as data, date_format(A.data_ini, '%d/%m/%Y') as data_ini, date_format(A.data_fim, '%d/%m/%Y') as data_fim, A.valor,            B.nome nomeFuncionario        FROM viagem      AS A        LEFT JOIN rh_clt AS B ON(B.id_clt = A.id_user)        WHERE A.status IN (" . implode(', ', $status) . ")        ORDER BY A.status, B.nome, A.data";        $viagem = mysql_query($result) or die(mysql_error());        while($row = mysql_fetch_assoc($viagem)){            $dados[$row['id_viagem']] = $row;        }        return $dados;    }        public function montaSelectViagemByStatus($status = [1]) {        $dados[] = 'SELECIONE';        $result = "        SELECT             A.id_viagem,            CONCAT(A.id_viagem, ' | ', A.nome, ' | ', A.valor) AS nome        FROM viagem      AS A        LEFT JOIN rh_clt AS B ON(B.id_clt = A.id_user)        WHERE A.status IN (" . implode(', ', $status) . ")        ORDER BY A.status, B.nome, A.data";        $viagem = mysql_query($result) or die(mysql_error());        while($row = mysql_fetch_assoc($viagem)){            $dados[$row['id_viagem']] = $row['nome'];        }        $dados = (count($dados) > 1) ? $dados : ['Nenhuma viagem aguardando acerto!'] ;        return $dados;    }        public function getViagemById($id) {        $result = "        SELECT             A.*, date_format(A.data, '%d/%m/%Y') as data, date_format(A.data_ini, '%d/%m/%Y') as data_ini, date_format(A.data_fim, '%d/%m/%Y') as data_fim, A.valor,             B.nome nomeFuncionario, E.nome AS funcao, B.locacao, B.tel_cel,            C.id AS id_acerto, C.total AS totalAcerto, C.valor_pagar, C.valor_devolver,             D.placa, D.modelo, D.linha, D.id_tipo_meio_transporte,             F.id_regiao        FROM viagem AS A        LEFT JOIN rh_clt AS B ON(B.id_clt = A.id_user)        LEFT JOIN viagem_acerto AS C ON (A.id_viagem = C.id_viagem AND C.status = 1)        LEFT JOIN meio_transporte AS D ON (A.id_meio_transporte = D.id)        LEFT JOIN curso AS E ON (B.id_curso = E.id_curso)        LEFT JOIN projeto AS F ON (A.id_projeto = F.id_projeto)        WHERE A.id_viagem = {$id}        ORDER BY B.nome, A.data";        $viagem = mysql_query($result) or die(mysql_error());        $row = mysql_fetch_assoc($viagem);        return $row;    }        public function getItensByIdViagem($id) {//        $sql = "//        SELECT * //        FROM viagem_itens_assoc//        WHERE id_viagem = $id//        ORDER BY id";        $sql = "        SELECT A.*, B.nome, B.valor_unitario, B.unidade        FROM viagem_itens_assoc A        LEFT JOIN itens_despesas B ON (A.id_item = B.id)        WHERE A.id_viagem = $id         -- AND A.status = 1         ORDER BY A.id";        $qry = mysql_query($sql) or die(mysql_error());        while($row = mysql_fetch_assoc($qry)){            $dados[$row['id']] = $row;        }        return $dados;    }        public function getAnexosByIdViagem($id, $tipo_anexo = [1,2,3]) {        $sql = "        SELECT *         FROM viagem_anexos        WHERE id_viagem = {$id} AND tipo_anexo IN (".implode(',', $tipo_anexo).")         AND status = 1        ORDER BY id";        $qry = mysql_query($sql) or die(mysql_error());        while($row = mysql_fetch_assoc($qry)){            $dados[$row['tipo_anexo']][$row['id_item']][$row['id']] = $row;        }        return $dados;    }        public function getAnexosAcertoByIdViagem($id) {        $sql = "        SELECT *         FROM viagem_anexos        WHERE id_viagem = {$id}        AND status = 1        ORDER BY id";        $qry = mysql_query($sql) or die(mysql_error());        while($row = mysql_fetch_assoc($qry)){            $dados[$row['id_acerto_item']][$row['id']] = $row;        }        return $dados;    }            public function getItensViagem() {        $sql = "SELECT * FROM viagem_itens WHERE status = 1 ORDER BY nome";        $qry = mysql_query($sql) or die(mysql_error());        while($row = mysql_fetch_assoc($qry)){            $dados[$row['id']] = $row['nome'];        }        return $dados;    }        public function getItensAcerto($id) {        $sql = "        SELECT A.*, B.nome        FROM viagem_acerto_itens A        LEFT JOIN itens_despesas B ON (A.id_item = B.id)        WHERE id_viagem_acerto = $id         AND status = 1         ORDER BY B.nome";        $qry = mysql_query($sql) or die(mysql_error());        while($row = mysql_fetch_assoc($qry)){            $dados[$row['id']] = $row;        }        return $dados;    }        public function getSaidasByIdViagem($id) {        $sql = "SELECT A.id_saida, A.nome, A.valor, n_documento  FROM saida_viagem A WHERE A.id_viagem = $id AND A.status = 1 ORDER BY A.id_saida";        $qry = mysql_query($sql) or die(mysql_error());        while($row = mysql_fetch_assoc($qry)){            $dados[$row['id_saida']] = $row;        }        return $dados;    }}?>