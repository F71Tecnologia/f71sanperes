<?phprequire_once('ApiClass.php'); /*PADRÃO OO*/class Banco{        private $api;        public function __construct() {            $this->api = new ApiClass();    }        /**     * METODO DO WEBSERVECE     */    public function getContaFinan(){                $contasFinanceiras = array();                try{            $campos = "A.id_banco as id, D.cnpj, C.classificador as conta_contabil, C.descricao, A.id_nacional as codigo_banco, A.razao as nome_banco, A.agencia as banco_agencia,'' as dg_agencia, A.conta, A.saldo as saldo_anterior";            $query = "SELECT {$campos} FROM bancos AS A                             LEFT JOIN contabil_contas_assoc_banco AS B ON(A.id_banco = B.id_banco)                            LEFT JOIN planodecontas AS C ON(B.id_conta = C.id_conta)                            LEFT JOIN rhempresa AS D ON (A.id_regiao = D.id_regiao)                      WHERE A.status_reg = 1 AND A.presta_conta = 1";                        $sql = mysql_query($query) or die("Erro ao selecioanar Contas Financeiras.");            $contasFinanceiras = null;            while ($row = mysql_fetch_assoc($sql)) {                foreach ($row as $k => $val) {                                        if($k=="conta"){                        $conta = str_replace(array(" ","-",",","."), "", $val);                        $digito = substr($conta, -1);                                                $conta = substr($conta, 0, -1);                                                $contasFinanceiras[$c][$k] = $conta;                        $contasFinanceiras[$c]['dg_conta'] = $digito;                    }else{                        $contasFinanceiras[$c][$k] = utf8_encode($val);                    }                }                $c++;            }                    }  catch (Exception $e){            echo $e->getMessage('Erro ao selecionar Contas Financeiras');        }                return $contasFinanceiras;             }        public function selectBanco($id_regiao) {        $sql = mysql_query("SELECT *                            FROM bancos                            WHERE id_regiao = '{$id_regiao}' AND interno = '1' AND status_reg = '1'                            ORDER BY id_banco DESC");        $banco = array("-1" => "« Selecione »");        while ($rst = mysql_fetch_assoc($sql)) {                    $banco[$rst['id_banco']] = $rst['id_banco'] . " - " . $rst['nome'] . " - " . $rst['agencia'] . " / " . $rst['conta'];        }        return $banco;    }        public function getBancoAnual($id_regiao, $banco){        if($banco == 'todos'){            $sql = "SELECT *                FROM bancos                WHERE status_reg ='1' AND id_regiao = $id_regiao";        }else{            $sql = "SELECT *                FROM bancos                WHERE status_reg ='1' AND id_banco = {$banco} AND id_regiao = $id_regiao";        }        $banco = mysql_query($sql) or die(mysql_error());            return $banco;    }        public function getControleSaldo($id_regiao = null) {         if($id_regiao) $aux = " A.id_regiao in ({$id_regiao}) AND ";        $sql = "SELECT A.id_banco, A.id_nacional, A.nome AS nome_banco, A.agencia, A.conta, B.nome AS nome_projeto, A.saldo, A.principal/*, COUNT(C.id_saida) AS sai_hj*/            FROM bancos AS A            LEFT JOIN projeto AS B ON (B.id_projeto = A.id_projeto)            /*LEFT JOIN saida AS C ON (C.id_banco = A.id_banco)*/            WHERE $aux A.status_reg = 1 AND A.interno = 1 /*AND DATE_FORMAT(data_proc, '%Y-%m-%d') = DATE_FORMAT(CURRENT_DATE(), '%Y-%m-%d')*/            GROUP BY A.id_banco            ORDER BY A.principal DESC, A.id_banco";                    $saldo = mysql_query($sql) or die(mysql_error());        return $saldo;    }        public function getSaidaBanco($id_banco){        $sql = "SELECT *            FROM saida            WHERE DATE_FORMAT(data_proc, '%Y-%m-%d') = DATE_FORMAT(CURRENT_DATE(), '%Y-%m-%d') AND id_banco = '{$id_banco}'";        $sai = mysql_query($sql) or die(mysql_error());        return $sai;    }        public function selectBancoMaster($id_master) {        $sql = mysql_query("SELECT *                            FROM bancos                            WHERE id_regiao IN (SELECT id_regiao FROM regioes WHERE id_master = {$id_master} AND status_reg = 1) AND interno = '1' AND status_reg = '1'                            ORDER BY id_banco DESC");        $banco = array("-1" => "« Selecione »");        while ($rst = mysql_fetch_assoc($sql)) {                    $banco[$rst['id_banco']] = $rst['id_banco'] . " - " . $rst['nome'] . " - " . $rst['agencia'] . " / " . $rst['conta'];        }        return $banco;    }    }function getBanco($id_regiao) {    $sql = "SELECT A.*, B.nome AS nome_projeto            FROM bancos AS A            LEFT JOIN projeto AS B ON (A.id_projeto = B.id_projeto)            WHERE A.id_regiao = '{$id_regiao}'            AND A.status_reg = 1";    $banco_fin = mysql_query($sql) or die(mysql_error());    return $banco_fin;}function getBancoID($id_banco) {    $sql = "SELECT A.*, B.nome AS nome_projeto, C.regiao AS nome_regiao            FROM bancos AS A            LEFT JOIN projeto AS B ON (A.id_projeto = B.id_projeto)              LEFT JOIN regioes AS C ON (A.id_regiao = C.id_regiao)            WHERE A.id_banco = '{$id_banco}'";    $banco = mysql_query($sql) or die(mysql_error());    $row = mysql_fetch_assoc($banco);    return $row;}function getBancoProj($id_regiao,$id_projeto) {    $sql = "SELECT *            FROM bancos            WHERE id_regiao = '{$id_regiao}'            AND id_projeto = {$id_projeto} AND status_reg = 1";    $banco_fin = mysql_query($sql) or die(mysql_error());    return $banco_fin;}function getBancoBD() {    $sql = mysql_query("SELECT * FROM listabancos ORDER BY id_lista");    $rst = array("-1" => "« Selecione »");    while ($rst = mysql_fetch_assoc($sql)) {        $banco[$rst['id_lista']] = $rst['id_lista'] . " - " . $rst['banco'];    }    return $banco;}function getBancoBDID($lista_banco) {    $sql = "SELECT * FROM listabancos WHERE id_lista = '{$lista_banco}'";    $banco = mysql_query($sql) or die(mysql_error());    $row = mysql_fetch_assoc($banco);    return $row;}function getBancoBDIDNacional($id_nacional) {    $sql = "SELECT * FROM listabancos WHERE id_nacional = '{$id_nacional}'";    $banco = mysql_query($sql) or die(mysql_error());    $row = mysql_fetch_assoc($banco);    return $row;}function cadBanco($id_regiao, $usuario) {        $local_banco = $_REQUEST['interno'];    $projeto = $_REQUEST['projeto'];    $banco = $_REQUEST['banco'];    $nome = acentoMaiusculo($_REQUEST['nome']);    $localidade = acentoMaiusculo($_REQUEST['localidade']);    $endereco = acentoMaiusculo($_REQUEST['endereco']);    $conta = $_REQUEST['conta'];    $agencia = $_REQUEST['agencia'];    $gerente = acentoMaiusculo($_REQUEST['gerente']);    $tel = $_REQUEST['tel'];    $id_regiao = $_REQUEST['regiao_selecionada'];        //dados do banco selecionado    $row = getBancoBDID($banco);    $id_nacional = $row['id_nacional'];    $razao = $row['banco'];    $site = $row['site'];        if (($nome == '')) {        $_SESSION['MESSAGE'] = "Verifique o campo Nome, ele não pode ser vazio";        $_SESSION['MESSAGE_COLOR'] = 'message-red';        $_SESSION['regiao'] = $id_regiao;            } else {        $insere_banco = mysql_query("INSERT INTO bancos(id_regiao, id_nacional, nome, razao, localidade, conta, agencia, endereco, tel, gerente, site, id_projeto, interno) values         ('{$id_regiao}','{$id_nacional}','{$nome}','{$razao}','{$localidade}','{$conta}','{$agencia}','{$endereco}','{$tel}','{$gerente}','{$site}','$projeto','$local_banco')") or die(mysql_error());        $novoBanco = mysql_insert_id();                //dados usuario para cadastro de log        $local = "Gestão de Bancos";        $ip = $_SERVER['REMOTE_ADDR'];        $acao = "Cadastro de Banco na Região ID{$id_regiao} - {$nome}({$novoBanco}))";        $id_usuario = $usuario['id_funcionario'];        $tipo_usuario = $usuario['tipo_usuario'];        $grupo_usuario = $usuario['grupo_usuario'];        $regiao = $usuario['id_regiao'];                $insere_log = mysql_query("INSERT INTO log (id_user, id_regiao, tipo_user, grupo_user, local, horario, ip, acao) VALUES          ('{$id_usuario}', '{$regiao}', '{$tipo_usuario}', '{$grupo_usuario}', '{$local}', NOW(), '{$ip}', '{$acao}')") or die(mysql_error());                if ($insere_banco && $insere_log) {            $_SESSION['MESSAGE'] = 'Informações gravadas com sucesso!';            $_SESSION['MESSAGE_COLOR'] = 'message-blue';            $_SESSION['MESSAGE_TYPE'] = 'info';            $_SESSION['regiao'] = $id_regiao;            $_SESSION['pausa'] = 'pausar';                    } else {            $_SESSION['MESSAGE'] = 'Erro ao cadastrar a unidade '.$nome;            $_SESSION['MESSAGE_COLOR'] = 'message-red';            $_SESSION['regiao'] = $id_regiao;            $_SESSION['pausa'] = 'pausar';        }    }}function alteraBanco($usuario) {        $local_banco = $_REQUEST['interno'];    $projeto = $_REQUEST['projeto'];    $banco = $_REQUEST['banco'];    $nome = acentoMaiusculo($_REQUEST['nome']);    $localidade = acentoMaiusculo($_REQUEST['localidade']);    $endereco = acentoMaiusculo($_REQUEST['endereco']);    $conta = $_REQUEST['conta'];    $agencia = $_REQUEST['agencia'];    $gerente = acentoMaiusculo($_REQUEST['gerente']);    $tel = $_REQUEST['tel'];    $id_regiao = $_REQUEST['regiao_selecionada'];    $id_banco = $_REQUEST['id_banco'];        //dados do banco selecionado    $row = getBancoBDID($banco);    $id_nacional = $row['id_nacional'];    $razao = $row['banco'];    $site = $row['site'];        //dados usuario para cadastro de log    $local = "Gestão de Bancos";    $ip = $_SERVER['REMOTE_ADDR'];    $acao = "Banco Editado: ID{$id_banco}";    $id_usuario = $usuario['id_funcionario'];    $tipo_usuario = $usuario['tipo_usuario'];    $grupo_usuario = $usuario['grupo_usuario'];    $regiao = $usuario['id_regiao'];                if (($nome == '')) {        $_SESSION['MESSAGE'] = "Verifique o campo Nome, ele não pode ser vazio";        $_SESSION['MESSAGE_COLOR'] = 'message-red';        $_SESSION['regiao'] = $id_regiao;        } else {                $altera_banco = mysql_query("UPDATE bancos SET id_nacional = '{$id_nacional}', nome = '{$nome}', razao = '{$razao}', localidade = '{$localidade}', conta = '{$conta}',                        agencia = '{$agencia}', endereco = '{$endereco}', tel ='{$tel}', gerente='{$gerente}', site='{$site}' ,                        id_projeto ='{$projeto}', interno = '{$local_banco}' WHERE id_banco = '{$id_banco}' LIMIT 1") or die(mysql_error());                $insere_log = mysql_query("INSERT INTO log (id_user, id_regiao, tipo_user, grupo_user, local, horario, ip, acao) VALUES                                    ('{$id_usuario}', '{$regiao}', '{$tipo_usuario}', '{$grupo_usuario}', '{$local}', NOW(), '{$ip}', '{$acao}')") or die(mysql_error());                if ($altera_banco && $insere_log) {            $_SESSION['MESSAGE'] = 'Informações alteradas com sucesso!';            $_SESSION['MESSAGE_COLOR'] = 'message-blue';            $_SESSION['MESSAGE_TYPE'] = 'info';            $_SESSION['regiao'] = $id_regiao;            $_SESSION['pausa'] = 'pausar';            session_write_close();            header('Location: index.php');        } else {            $_SESSION['MESSAGE'] = 'Erro ao atualizar a unidade';            $_SESSION['MESSAGE_COLOR'] = 'message-red';            $_SESSION['regiao'] = $id_regiao;            $_SESSION['pausa'] = 'pausar';            session_write_close();            header('Location: index.php');        }    }}?>