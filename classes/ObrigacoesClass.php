<?phpclass ObrigacoesClass {        public static function getExpiraHoje() {        $usuario = carregaUsuario();        $sql = mysql_query("SELECT COUNT(id_oscip) FROM                    (SELECT *,                             CASE periodo                                 WHEN 'Dias' THEN DATEDIFF(DATE_ADD(data_publicacao, INTERVAL numero_periodo DAY),NOW())                                 WHEN 'Meses' THEN DATEDIFF(DATE_ADD(data_publicacao, INTERVAL numero_periodo MONTH),NOW())                                 WHEN 'Anos' THEN DATEDIFF(DATE_ADD(data_publicacao, INTERVAL numero_periodo YEAR),NOW())                                 WHEN 'Período' THEN DATEDIFF(oscip_data_termino, NOW())                             END as prazo_expiracao                    FROM obrigacoes_oscip                    WHERE id_master = {$usuario['id_master']} AND status = 1)                    as obrigacoes                    WHERE prazo_expiracao = 0 AND tipo_oscip != ''");        $tot = mysql_result($sql,0);        return $tot;    }        public static function getExpirado() {        $usuario = carregaUsuario();        $sql = mysql_query("SELECT COUNT(id_oscip) FROM                    (SELECT *,                             CASE periodo                                 WHEN 'Dias' THEN DATEDIFF(DATE_ADD(data_publicacao, INTERVAL numero_periodo DAY),NOW())                                 WHEN 'Meses' THEN DATEDIFF(DATE_ADD(data_publicacao, INTERVAL numero_periodo MONTH),NOW())                                 WHEN 'Anos' THEN DATEDIFF(DATE_ADD(data_publicacao, INTERVAL numero_periodo YEAR),NOW())                                 WHEN 'Período' THEN DATEDIFF(oscip_data_termino, NOW())                             END as prazo_expiracao                    FROM obrigacoes_oscip                    WHERE id_master = {$usuario['id_master']} AND status = 1)                    as obrigacoes                    WHERE prazo_expiracao < 0 AND prazo_expiracao IS NOT NULL AND tipo_oscip != ''");        $tot = mysql_result($sql,0);        return $tot;    }        public static function getIraExpirar() {        $usuario = carregaUsuario();        $sql = mysql_query("SELECT COUNT(id_oscip) FROM                    (SELECT *,                             CASE periodo                                 WHEN 'Dias' THEN DATEDIFF(DATE_ADD(data_publicacao, INTERVAL numero_periodo DAY),NOW())                                 WHEN 'Meses' THEN DATEDIFF(DATE_ADD(data_publicacao, INTERVAL numero_periodo MONTH),NOW())                                 WHEN 'Anos' THEN DATEDIFF(DATE_ADD(data_publicacao, INTERVAL numero_periodo YEAR),NOW())                                 WHEN 'Período' THEN DATEDIFF(oscip_data_termino, NOW())                             END as prazo_expiracao                    FROM obrigacoes_oscip                    WHERE id_master = {$usuario['id_master']} AND status = 1)                    as obrigacoes                    WHERE prazo_expiracao > 0 AND prazo_expiracao IS NOT NULL AND tipo_oscip != ''");        $tot = mysql_result($sql,0);        return $tot;    }        public static function getTipoObrigacoes($criteria =  null, $order =  'tipo_nome', $limit =  null) {        $usuario = carregaUsuario();        $auxLimit = (!empty($limit)) ? "LIMIT $limit" : $limit;        $auxOrder = (!empty($order)) ? "ORDER BY $order" : $order;        $auxCriteria = (!empty($criteria)) ? "AND $criteria" : $criteria;        $sql = mysql_query("SELECT * FROM tipo_doc_oscip WHERE tipo_status = 1 $auxCriteria $auxOrder $auxLimit");        while($row = mysql_fetch_assoc($sql)){            $dados[] = $row;        }        return $dados;    }        public function getObrigacoes($criteria =  null, $order =  null, $limit =  null) {        $usuario = carregaUsuario();        $auxLimit = (!empty($limit)) ? "LIMIT $limit" : $limit;        $auxOrder = (!empty($order)) ? "ORDER BY $order" : $order;        $auxCriteria = (!empty($criteria)) ? "AND $criteria" : $criteria;        $sql = "SELECT * FROM obrigacoes_oscip WHERE id_master = '{$usuario['id_master']}' AND status = 1 $auxCriteria $auxOrder $auxLimit";        $sql = mysql_query($sql);        while($row = mysql_fetch_assoc($sql)){            $dados[] = $row;        }        return $dados;    }        public function getObrigacoesAnexos($id_obrigacao, $criteria =  null, $order =  null, $limit =  null) {        $usuario = carregaUsuario();        $auxLimit = (!empty($limit)) ? "LIMIT $limit" : $limit;        $auxOrder = (!empty($order)) ? "ORDER BY $order" : $order;        $auxCriteria = (!empty($criteria)) ? "AND $criteria" : $criteria;        $sql = "SELECT * FROM obrigacoes_oscip_anexos WHERE id_oscip = $id_obrigacao AND status = 1 $auxCriteria $auxOrder $auxLimit";        $sql = mysql_query($sql);        while($row = mysql_fetch_assoc($sql)){            $dados[] = $row;        }        return $dados;    }        public function getValidadeObrigacao($id_obrigacao) {                $row_obrigacao = $this->getObrigacoes("id_oscip = '$id_obrigacao'")[0];                if (utf8_decode($row_obrigacao['periodo']) == "Período") {            $data_inicio = new DateTime($row_obrigacao['oscip_data_inicio']);            $data_termino = new DateTime($row_obrigacao['oscip_data_termino']);//            list($ano, $mes, $dia) = explode('-', $row_obrigacao['oscip_data_inicio']);//            list($ano_2, $mes_2, $dia_2) = explode('-', $row_obrigacao['oscip_data_termino']);//            $data_inicio = mktime(0, 0, 0, $mes, $dia, $ano);//            $data_termino = mktime(0, 0, 0, $mes_2, $dia_2, $ano_2);            $total = $data_termino->diff($data_inicio);            $validade = $total->days.' dias';        } else {            $validade = $row_obrigacao['numero_periodo'] . ' ' . $row_obrigacao['periodo'];        }        return $validade;    }        public function getStatusObrigacao($periodo, $data_publicacao, $n_periodo, $data_termino) {        if ($periodo != 'Indeterminado'){            $data_atual = new DateTime(date('Y-m-d'));            if ($periodo == 'Dias') {                $data_vencimento = new DateTime(date('Y-m-d', strtotime("+$n_periodo days",strtotime("$data_publicacao"))));            } else if ($periodo == 'Meses') {                $data_vencimento = new DateTime(date('Y-m-d', strtotime("+$n_periodo month",strtotime("$data_publicacao"))));            } else if ($periodo == 'Anos') {                $data_vencimento = new DateTime(date('Y-m-d', strtotime("+$n_periodo year",strtotime("$data_publicacao"))));            } else if(utf8_decode($periodo) == 'Período'){                $data_vencimento = new DateTime($data_termino);            }            $diff = $data_vencimento->diff($data_atual);                    if ($diff->days == 0) {                $status = '<span class="text-warning text-bold">Expira hoje!</span>';            } elseif ($data_vencimento > $data_atual && $diff->days <= 30) {                $status = '<span class="text-info text-bold">Expira em ' . $diff->days . ' dias!</span>';            } elseif ($data_atual >= $data_vencimento) {                $status = '<span class="text-danger text-bold>Expirado</span>';            } else {                $status = '<span class="text-success text-bold">OK</span>';            }        } else {            $status = $periodo;        }        return $status;    }        public static function getDiasVencimento($data_vencimento, $tipo, $order =  null, $limit =  null) {        $usuario = carregaUsuario();        $sql = mysql_query("SELECT DATEDIFF('$data_vencimento',NOW()) as dias FROM obrigacoes_oscip WHERE tipo_oscip = '$tipo' AND id_master = '{$usuario['id_master']}' AND status = 1 ORDER BY data_publicacao DESC ");        $row = mysql_fetch_assoc($sql);        return $row['dias'];    }        public static function getOficiosSemAnexo($criteria =  null, $order =  null, $limit =  null) {        $usuario = carregaUsuario();        $auxCriteria = (!empty($criteria)) ? "AND $criteria" : $criteria;        $auxLimit = (!empty($limit)) ? "LIMIT $limit" : $limit;        $auxOrder = (!empty($order)) ? "ORDER BY $order" : $order;        $sql = "SELECT * FROM obrigacoes_oscip WHERE tipo_oscip IN('Ofícios Recebidos', 'Ofícios Enviados') AND id_oscip NOT IN(SELECT B.id_oscip FROM obrigacoes_oscip_anexos B WHERE B.status = 1) AND id_master = '{$usuario['id_master']}' AND status = 1 $auxCriteria $auxOrder $auxLimit";        $sql = mysql_query($sql)or die(mysql_error());        while($row = mysql_fetch_assoc($sql)){            $dados[] = $row;        }        return $dados;    }        public static function cadastrarObrigacao($arrayObrigacao) {        $keys = implode(',', array_keys($arrayObrigacao));        $values = "'".implode("', '",($arrayObrigacao))."'";        $sql = "INSERT INTO obrigacoes_oscip ($keys) VALUES ($values)";        $sql = mysql_query($sql)or die(mysql_error());        return mysql_insert_id();    }        public static function editarObrigacao($arrayObrigacao, $id_obrigacao) {        foreach ($arrayObrigacao as $key => $value) {            $valores[] .= "$key = '$value'";        }        $valores = implode(', ',$valores);                $sql = "UPDATE obrigacoes_oscip SET $valores WHERE id_oscip = {$id_obrigacao} LIMIT 1";        $sql = mysql_query($sql)or die(mysql_error());        return $id_obrigacao;    }        public static function excluirObrigacao($id_obrigacao) {        $sql = "UPDATE obrigacoes_oscip SET status = 0 WHERE id_oscip = {$id_obrigacao} LIMIT 1";        $sql = mysql_query($sql)or die(mysql_error());        return $id_obrigacao;    }}?>